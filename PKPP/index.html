<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Kesejahteraan dan Personaliti Pelajar (PKPP)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar-animated {
            transition: width 0.5s ease-in-out;
        }
        .radio-container label {
            transition: all 0.2s ease-in-out;
        }
        .radio-container input:checked + label {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .welcome-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .welcome-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1);
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #results-container, #results-container * {
                visibility: visible;
            }
            #results-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div id="app" class="max-w-4xl w-full mx-auto bg-white shadow-lg rounded-lg pb-24">
        <!-- App content will be rendered here -->
        <div class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Memuatkan soal selidik...</p>
        </div>
    </div>
    <footer class="fixed bottom-0 left-0 right-0 text-center py-4 text-sm text-gray-500 bg-gray-50 no-print">
        2024@Unit Psikologi dan Kaunseling, IPGM
        <span class="mx-2">|</span>
        <a href="#" data-action="view-admin" class="hover:underline text-blue-600">Paparan Admin</a>
    </footer>
    <!-- Modal container -->
    <div id="modal-container"></div>
    <script>
        // --- STATE MANAGEMENT & INTERNAL DATA STORE ---
        let state = {
            currentSection: -1, // -1:welcome, 0:demo, 1:guardian, 2:personality, 3:ikpsi
            showResults: false,
            isAdminView: false,
            isAdminLoggedIn: false, // Security check for admin view
            responses: {
                demographics: {},
                guardianDemographics: {},
                personality: {},
                ikpsi: {}
            },
            submittedEmails: new Set()
        };
        // In-memory array to store all submission data for the session
        let allResponsesData = [];

        // --- QUESTIONNAIRE DATA ---
        const demographicsQuestions = [
            { id: 'name', label: 'Nama Penuh', type: 'text', required: true },
            { id: 'ic', label: 'No. MyKad (Tanpa sempang)', type: 'tel', required: true, maxLength: 12, pattern: '[0-9]*' },
            { id: 'email', label: 'Alamat Email', type: 'email', required: true },
            { id: 'gender', label: 'Jantina', type: 'select', options: ['Lelaki', 'Perempuan'], required: true },
            { id: 'race', label: 'Bangsa', type: 'select', options: ['Melayu', 'Cina', 'India', 'Bumiputera Sabah/Sarawak', 'Lain-lain'], required: true },
            { id: 'religion', label: 'Agama', type: 'select', options: ['Islam', 'Buddha', 'Kristian', 'Hindu', 'Lain-lain'], required: true },
            { id: 'phone', label: 'No. Telefon (Bimbit)', type: 'tel', required: true },
            { id: 'ipgKampus', label: 'IPGM/IPGK', type: 'select', options: ['IPG Kampus Bahasa Melayu', 'IPG Kampus Bahasa Antarabangsa', 'IPG Kampus Ilmu Khas', 'IPG Kampus Pendidikan Islam', 'IPG Kampus Pendidikan Teknik', 'IPG Kampus Raja Melewar', 'IPG Kampus Tun Hussein Onn', 'IPG Kampus Temenggong Ibrahim', 'IPG Kampus Perempuan Melayu Melaka', 'IPG Kampus Ipoh', 'IPG Kampus Pulau Pinang', 'IPG Kampus Tuanku Bainun', 'IPG Kampus Perlis', 'IPG Kampus Darul Aman', 'IPG Kampus Sultan Abdul Halim', 'IPG Kampus Tengku Ampuan Afzan', 'IPG Kampus Dato\' Razali Ismail', 'IPG Kampus Sultan Mizan', 'IPG Kampus Kota Bharu', 'IPG Kampus Kent', 'IPG Kampus Gaya', 'IPG Kampus Keningau', 'IPG Kampus Tawau', 'IPG Kampus Batu Lintang', 'IPG Kampus Sarawak', 'IPG Kampus Rajang', 'IPG Kampus Tun Abdul Razak'], required: true },
            { id: 'program', label: 'Program', type: 'select', options: ['PPISMP', 'PISMP', 'PISP', 'PDPP', 'PDPP KDC'], required: true },
            { id: 'semester', label: 'Semester', type: 'select', options: ['Semester 1', 'Semester 2', 'Semester 3', 'Semester 4', 'Semester 5', 'Semester 6', 'Semester 7', 'Semester 8', 'Semester 9', 'Semester 10', 'Semester 11', 'Semester 12'], required: true }
        ];
        const guardianDemographicsQuestions = [
            { id: 'guardian_name', label: 'Nama Ibu/Bapa/Penjaga', type: 'text', required: true },
            { id: 'guardian_phone', label: 'No. Telefon Ibu/Bapa/Penjaga', type: 'tel', required: true },
            { id: 'guardian_address', label: 'Alamat Penuh', type: 'textarea', required: true },
            { id: 'guardian_income', label: 'Jumlah Pendapatan Kasar Bulanan Isi Rumah', type: 'select', options: ['Tiada Pendapatan', 'Kurang dari RM2,500 (B40)', 'RM2,501 - RM5,000 (B40)', 'RM5,001 - RM10,960 (M40)', 'Lebih dari RM10,961 (T20)'], required: true },
        ];
        const personalityQuestions = [
            'Saya seorang yang menceriakan suasana majlis.', 'Saya kurang mengambil berat tentang orang lain.', 'Saya sentiasa bersedia.', 'Saya mudah berasa tertekan.', 'Saya mempunyai kosa kata yang luas.', 'Saya tidak banyak bercakap.', 'Saya cenderung untuk berurusan dengan orang lain.', 'Saya sering meninggalkan barang di merata tempat.', 'Saya tenang pada kebanyakan masa.', 'Saya sukar memahami idea-idea abstrak.', 'Saya berasa selesa dikelilingi orang ramai.', 'Saya sering menghina orang lain.', 'Saya memberikan tumpuan kepada sesuatu perkara secara terperinci.', 'Saya bimbang tentang sesuatu perkara.', 'Saya mempunyai imaginasi yang jelas.', 'Saya suka laksanakan tugas di belakang tabir.', 'Saya simpati dengan perasaan orang lain.', 'Saya sering membuat keadaan menjadi kucar-kacir.', 'Saya jarang berasa sedih.', 'Saya tidak berminat dengan idea-idea abstrak.', 'Saya selalu memulakan perbualan dengan orang lain.', 'Saya tidak berminat dengan masalah orang lain.', 'Saya menyelesaikan tugas dengan segera.', 'Saya mudah terganggu.', 'Saya mempunyai idea-idea yang bernas.', 'Saya kurang bercakap.', 'Saya seorang yang berhati lembut.', 'Saya sering lupa meletakkan kembali barang ke tempat asal.', 'Saya mudah berasa kecewa.', 'Saya tidak mempunyai imaginasi yang baik.', 'Saya selesa berbual dengan ramai orang di sesuatu majlis.', 'Saya tidak berminat berurusan dengan orang lain.', 'Saya suka kepada keteraturan.', 'Hati saya kerap berubah-ubah.', 'Saya cepat memahami sesuatu perkara.', 'Saya tidak suka memberi perhatian kepada diri sendiri.', 'Saya meluangkan masa untuk orang lain.', 'Saya mengelak daripada tanggungjawab.', 'Saya kerap mengalami perubahan emosi.', 'Saya sering menggunakan perkataan yang sukar.', 'Saya tidak kisah menjadi perhatian orang lain.', 'Saya memahami perasaan orang lain.', 'Saya seorang yang mengikut jadual.', 'Saya mudah rasa terganggu.', 'Saya selalu meluangkan masa meneliti sesuatu perkara.', 'Saya akan diam apabila bersama orang yang tidak dikenali.', 'Saya selalu membuat orang lain berasa selesa.', 'Saya teliti dalam kerja saya.', 'Saya sering berasa sedih.', 'Saya seorang yang banyak idea.'
        ];
        const ikpsiQuestions = [
            "Saya dapat mengenal emosi orang lain dengan baik.", "Saya dapat mengenal emosi saya dengan sepenuhnya.", "Saya sedar keadaan emosi yang sedang saya alami.", "Saya dapat menyelami emosi orang lain.", "Saya memahami perubahan emosi yang berlaku dalam diri saya.", "Saya memahami bahawa emosi saya boleh mempengaruhi tingkah laku orang lain.", "Saya mampu mengawal emosi walaupun dalam keadaan tertekan", "Saya mampu bertenang walaupun sedang marah.", "Saya dapat menangani tekanan dengan baik.", "Saya tidak pernah marah dalam hidup.", "Saya bertanggungjawab atas bidang pengajian yang saya pilih.", "Saya seorang yang berdikari.", "Saya bertanggungjawab terhadap laluan kerjaya yang saya pilih.", "Saya mampu memperkembang potensi diri secara berterusan.", "Saya suka akan situasi baharu yang dapat memperbaiki diri.", "Saya bersedia menerima pengalaman baharu.", "Saya suka menerima pengiktirafan atas tugasan yang saya lakukan.", "Saya memberikan ganjaran terhadap diri sendiri.", "Saya menjalankan tugas dengan baik tanpa mengharapkan pengiktirafan.", "Saya mempunyai masa untuk melakukan aktiviti yang saya sukai.", "Saya berupaya membahagikan masa untuk aktiviti belajar dengan kehidupan peribadi.", "Saya dapat menguruskan kehidupan peribadi dengan seimbang.", "Saya tidak pernah gagal dalam hidup.", "Saya mengamalkan pemakanan seimbang.", "Saya sihat jika mengambil makanan yang berkhasiat.", "Saya mengambil makanan yang berkhasiat untuk keperluan tubuh badan.", "Saya prihatin tentang berat badan saya.", "Saya akan membuat regangan apabila duduk terlalu lama.", "Saya memilih beriadah berbanding berehat di bilik.", "Saya mandi setiap hari untuk memastikan badan saya bersih.", "Saya mencuci tangan untuk mengekalkan kebersihan.", "Saya menjaga kebersihan walau di manan-mana saya berada.", "Saya mengambil ubat dengan konsultasi doktor.", "Saya tidak mengambil bahan terlarang seperti dadah/inhalan/rokok/vape.", "Saya tidak minum minuman beralkohol.", "Saya tidak pernah sakit sepanjang hidup.", "Saya seronok melakukan aktiviti bermakna bersama ahli keluarga.", "Saya sentiasa menjaga hubungan baik dengan ahli keluarga.", "Saya sentiasa memberi sokongan kepada ahli keluarga.", "Saya menerima rakan sebaya seadanya.", "Saya menghormati pandangan rakan sebaya.", "Saya mengambil berat kebajikan rakan sebaya.", "Saya menjaga hubungan baik dengan komuniti setempat.", "Saya menerima kehidupan berkomuniti.", "Saya menerima komuniti setempat saya seadanya.", "Saya tidak pernah berbohong dalam hidup.", "Saya berbincang dengan rakan untuk meningkatkan pengetahuan.", "Saya menguasai bidang pengajian yang dipelajari.", "Saya mencari ilmu pengetahuan untuk meningkatkan pencapaian diri.", "Saya mengenalpasti masalah yang perlu diselesaikan.", "Saya mencari jalan penyelesaian bagi setiap masalah.", "Saya berfikir secara rasional dalam membuat sesuatu keputusan.", "Saya mampu menghasilkan idea baharu dalam pelbagai situasi.", "Saya melihat sesuatu perkara dari berbagai sudut.", "Saya sentiasa meneroka idea baharu.", "Saya tidak pernah rasa kecil hati terhadap sesiapa.", "Saya percaya setiap perkara yang berlaku mempunyai kebaikan disebaliknya.", "Saya menganggap belajar itu sebagai kewajipan.", "Saya melakukan kebaikan dalam kehidupan.", "Saya menghayati nilai murni dalam kehidupan.", "Saya tidak menyalahgunakan kemudahan di institusi pendidikan untuk tujuan peribadi.", "Saya seorang yang amanah.", "Saya boleh dipercayai dalam menjalankan tugas.", "Saya boleh menjalankan tugasan tanpa pengawasan orang lain.", "Saya tidak pernah suka ilmu pengetahuan.", "Saya menerima jantina saya.", "Saya selesa dengan jantina saya.", "Saya menghormati diri saya.", "Saya menghormati kelainan budaya dalam masyarakat.", "Saya boleh melibatkan diri dalam aktiviti silang budaya.", "Saya boleh bertoleransi dengan silang budaya (makanan, pakaian dan gaya hidup).", "Saya berupaya menjalankan tugasan dengan cekap.", "Saya tidak menangguh kerja.", "Saya mampu menyiapkan sesuatu tugasan.", "Saya tidak pernah melakukan tugasan pada saat akhir.", "Saya sedar kepentingan pengurusan kewangan yang bijak.", "Saya tahu kepentingan mengurus perbelanjaan harian.", "Saya mengamalkan sikap menabung.", "Saya mengamalkan sikap berjimat cermat.", "Saya dapati perbelanjaan bulanan mencukupi.", "Saya merancang perbelanjaan saya.", "Saya mempunyai simpanan untuk waktu kecemasan.", "Saya tidak bimbang tentang masalah kewangan.", "Saya tidak pernah berbelanja."
        ];

        // --- SCORING LOGIC FOR IKPSI-P (8 Constructs + Consistency) ---
        const ikpsiScoring = {
            domains: {
                emosi: { label: 'Emosi', items: [1, 2, 3, 4, 5, 6, 7, 8, 9] },
                kendiri: { label: 'Kendiri', items: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22] },
                fizikal: { label: 'Fizikal', items: [24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35] },
                perhubungan: { label: 'Perhubungan', items: [37, 38, 39, 40, 41, 42, 43, 44, 45] },
                intelektual: { label: 'Intelektual', items: [47, 48, 49, 50, 51, 52, 53, 54, 55] },
                spiritual: { label: 'Spiritual', items: [57, 58, 59, 60, 61, 62, 63, 64] },
                identiti: { label: 'Identiti', items: [66, 67, 68, 69, 70, 71, 72, 73, 74] },
                kewangan: { label: 'Kewangan', items: [76, 77, 78, 79, 80, 81, 82, 83] }
            },
            consistencyItems: [10, 23, 36, 46, 56, 65, 75, 84],
            getScores: function(responses) {
                const scores = {};
                for (const domainKey in this.domains) {
                    const domain = this.domains[domainKey];
                    let totalScore = 0;
                    domain.items.forEach(itemIndex => {
                        totalScore += responses[itemIndex - 1] || 3;
                    });
                    scores[domainKey] = totalScore;
                }
                let consistencyScore = 0;
                this.consistencyItems.forEach(itemIndex => {
                    consistencyScore += responses[itemIndex - 1] || 0;
                });
                scores.keselarasan = consistencyScore;
                return scores;
            }
        };

        // --- EVENT HANDLERS & STATE UPDATERS ---
        function startSurvey() {
            state.currentSection = 0;
            render();
            window.scrollTo(0, 0);
        }

        function handleDemographicChange(id, value) {
            const inputElement = document.getElementById(id);
            if (id === 'ic' || id === 'phone') {
                let digitsOnly = value.replace(/\D/g, '');
                if (id === 'ic') {
                    digitsOnly = digitsOnly.slice(0, 12);
                    updateICCounter(digitsOnly);
                }
                state.responses.demographics[id] = digitsOnly;
                if (inputElement) {
                    inputElement.value = digitsOnly;
                }
            } else {
                state.responses.demographics[id] = value;
            }
        }

        function handleGuardianDemographicChange(id, value) {
            const inputElement = document.getElementById(id);
            if (id === 'guardian_phone') {
                let digitsOnly = value.replace(/\D/g, '');
                state.responses.guardianDemographics[id] = digitsOnly;
                if (inputElement) {
                    inputElement.value = digitsOnly;
                }
            } else {
                state.responses.guardianDemographics[id] = value;
            }
        }

        function updateICCounter(icValue) {
            const counterElement = document.getElementById('ic-counter');
            if (counterElement) {
                const length = icValue.length;
                counterElement.textContent = `(${length}/12)`;
                counterElement.className = `absolute inset-y-0 right-0 pr-3 flex items-center text-sm pointer-events-none font-medium ${length === 12 ? 'text-green-600' : 'text-red-500'}`;
            }
        }

        function handlePersonalityChange(index, value) {
            state.responses.personality[index] = parseInt(value);
            updateRadioButtonVisual('personality', index, value);
        }

        function handleIkpsiChange(index, value) {
            state.responses.ikpsi[index] = parseInt(value);
            updateRadioButtonVisual('ikpsi', index, value);
        }

        function updateRadioButtonVisual(section, index, selectedValue) {
            const radioInputs = document.querySelectorAll(`input[name="${section}-${index}"]`);
            radioInputs.forEach(input => {
                const label = document.querySelector(`label[for="${input.id}"]`);
                if (!label) return;
                const baseClass = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 cursor-pointer';
                let specificClass = 'bg-gray-200 text-gray-600 hover:bg-gray-300';

                if (parseInt(input.value) === parseInt(selectedValue)) {
                    let colorClass = section === 'personality' ? 'bg-blue-500' : 'bg-green-500';
                    specificClass = `${colorClass} text-white shadow-lg transform scale-110`;
                }

                label.className = `${baseClass} ${specificClass}`;
            });
        }

        function validateCurrentSection() {
            if (state.currentSection === 0) {
                for (const field of demographicsQuestions) {
                    if (field.required && !state.responses.demographics[field.id]) {
                        return { isValid: false, message: `Sila lengkapkan maklumat: ${field.label}.` };
                    }
                }
                if ((state.responses.demographics.ic || '').length !== 12) {
                    return { isValid: false, message: `No. MyKad mesti mengandungi tepat 12 digit nombor.` };
                }
                const email = state.responses.demographics.email;
                if (email && state.submittedEmails.has(email.toLowerCase())) {
                    return { isValid: false, message: 'Alamat emel ini telah digunakan untuk menjawab soal selidik. Setiap emel hanya boleh digunakan sekali sahaja.' };
                }
            } else if (state.currentSection === 1) {
                for (const field of guardianDemographicsQuestions) {
                    if (field.required && !state.responses.guardianDemographics[field.id]) {
                        return { isValid: false, message: `Sila lengkapkan maklumat: ${field.label}.` };
                    }
                }
            } else if (state.currentSection === 2) {
                if (Object.keys(state.responses.personality).length < personalityQuestions.length) {
                    return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian C.' };
                }
            } else if (state.currentSection === 3) {
                if (Object.keys(state.responses.ikpsi).length < ikpsiQuestions.length) {
                    return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian D.' };
                }
            }
            return { isValid: true };
        }

        function handleNextSection() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                showModal(validation.message);
                return;
            }
            state.currentSection++;
            render();
            window.scrollTo(0, 0);
        }

        function handlePrevSection() {
            state.currentSection = Math.max(0, state.currentSection - 1);
            render();
            window.scrollTo(0, 0);
        }

        // --- SCORE CALCULATIONS ---
        function calculatePersonalityScores() {
            const r = state.responses.personality;
            const p = (index) => r[index - 1] || 3;
            const reverse = (score) => 6 - score;
            const scores = {
                extraversion: p(1) + reverse(p(6)) + p(11) + reverse(p(16)) + p(21) + reverse(p(26)) + p(31) + reverse(p(36)) + p(41) + reverse(p(46)),
                agreeableness: reverse(p(2)) + p(7) + reverse(p(12)) + p(17) + reverse(p(22)) + p(27) + reverse(p(32)) + p(37) + p(42) + p(47),
                conscientiousness: p(3) + reverse(p(8)) + p(13) + reverse(p(18)) + p(23) + reverse(p(28)) + p(33) + reverse(p(38)) + p(43) + p(48),
                neuroticism: p(4) + reverse(p(9)) + p(14) + reverse(p(19)) + p(24) + p(29) + p(34) + p(39) + p(44) + p(49),
                openness: p(5) + reverse(p(10)) + p(15) + reverse(p(20)) + p(25) + reverse(p(30)) + p(35) + p(40) + p(45) + p(50)
            };
            const toPercent = (score) => Math.round(((score - 10) / 40) * 100);
            return {
                extraversion: toPercent(scores.extraversion),
                agreeableness: toPercent(scores.agreeableness),
                conscientiousness: toPercent(scores.conscientiousness),
                neuroticism: toPercent(scores.neuroticism),
                openness: toPercent(scores.openness)
            };
        }

        function calculateIkpsiScores() {
            return ikpsiScoring.getScores(state.responses.ikpsi);
        }

        // --- SHOW RESULTS ---
        async function showResults() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                showModal(validation.message);
                return;
            }

            const submitButton = document.querySelector('button[data-action="show-results"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Memproses...</div>`;
            }

            // Collect all data for internal storage
            const dataToStore = {
                timestamp: new Date().toLocaleString('ms-MY'),
                demographics: state.responses.demographics,
                guardianDemographics: state.responses.guardianDemographics,
                personalityScores: calculatePersonalityScores(),
                ikpsiScores: calculateIkpsiScores()
            };

            // Store data in the internal array
            allResponsesData.push(dataToStore);

            const email = state.responses.demographics.email;
            if (email) {
                state.submittedEmails.add(email.toLowerCase());
            }

            setTimeout(() => {
                state.showResults = true;
                render();
                window.scrollTo(0, 0);
            }, 500);
        }

        // --- PDF GENERATION ---
        const interpretations = {
            personality: {
                extraversion: { label: 'Extraversion', Tinggi: 'Sangat suka bersosial, bertenaga, dan cenderung mengalami emosi positif.', Sederhana: 'Keseimbangan antara suka bersosial dan meluangkan masa bersendirian.', Rendah: 'Lebih suka bersendirian, pendiam, dan tidak memerlukan banyak rangsangan sosial.' },
                agreeableness: { label: 'Agreeableness (Kepatuhan)', Tinggi: 'Cenderung bersikap belas kasihan, bekerjasama, dan baik hati.', Sederhana: 'Gabungan antara sikap mementingkan diri sendiri dan orang lain.', Rendah: 'Lebih kompetitif, kritis, dan kadangkala curiga terhadap niat orang lain.' },
                conscientiousness: { label: 'Conscientiousness (Kehematan)', Tinggi: 'Sangat teratur, bertanggungjawab, dan berdisiplin.', Sederhana: 'Keseimbangan antara spontan dan teratur.', Rendah: 'Lebih spontan, kurang teratur, dan kadangkala cuai.' },
                neuroticism: { label: 'Neuroticism (Neurotisme)', Tinggi: 'Cenderung mengalami emosi negatif seperti kebimbangan, kemarahan, dan kesedihan.', Sederhana: 'Kestabilan emosi yang sederhana, bertindak balas secara normal terhadap tekanan.', Rendah: 'Sangat stabil dari segi emosi, tenang, dan sukar berasa tertekan.' },
                openness: { label: 'Openness (Keterbukaan)', Tinggi: 'Sangat kreatif, ingin tahu, dan terbuka kepada pengalaman baharu.', Sederhana: 'Keseimbangan antara menghargai tradisi dan keterbukaan kepada idea baharu.', Rendah: 'Lebih praktikal, konvensional, dan lebih suka rutin.' }
            },
            ikpsi: {
                emosi: { label: 'Emosi', 'Tinggi': 'Anda mempunyai tahap keupayaan yang sangat baik dalam memahami emosi,  sangat peka terhadap emosi,  mampu mengurus dan mengawal emosi dengan sangat berkesan.', 'Sederhana Tinggi':'Anda mempunyai tahap keupayaan yang baik dalam memahami emosi,  peka terhadap emosi,  mampu mengurus dan mengawal emosi dengan berkesan.', 'Sederhana': 'Anda mempunyai tahap keupayaan yang agak baik dalam memahami emosi, agak peka terhadap emosi, agak mampu mengurus dan mengawal emosi dengan berkesan.', 'Sederhana Rendah':'Anda mempunyai tahap keupayaan yang rendah dalam memahami emosi, kurang peka terhadap emosi, kurang mampu mengurus dan mengawal emosi dengan berkesan.', 'Rendah': 'Anda mempunyai tahap keupayaan yang sangat rendah dalam memahami emosi, sangat kurang peka terhadap emosi, sangat tidak mampu mengurus dan mengawal emosi dengan berkesan.'},
                kendiri: { label: 'Kendiri', 'Tinggi': 'Anda merasakan diri berkembang dengan sangat baik meliputi autonomi, perkembangan kendiri, pengiktirafan dan keseimbangan kehidupan bagi memaksimumkan potensi dan kemajuan diri.','Sederhana Tinggi':'Anda berasakan diri berkembang dengan baik meliputi autonomi, perkembangan kendiri, pengiktirafan dan keseimbangan kehidupan bagi memaksimumkan potensi dan kemajuan diri.','Sederhana': 'Anda berasakan diri agak berkembang dengan baik meliputi autonomi, perkembangan kendiri, pengiktirafan dan keseimbangan kehidupan bagi memaksimumkan potensi dan kemajuan diri.', 'Sederhana Rendah':'Anda berasakan diri tidak berkembang meliputi autonomi, perkembangan kendiri, pengiktirafan dan keseimbangan kehidupan bagi memaksimumkan potensi dan kemajuan diri.', 'Rendah': 'Anda berasakan diri sangat tidak berkembang meliputi autonomi, perkembangan kendiri, pengiktirafan dan keseimbangan kehidupan bagi memaksimumkan potensi dan kemajuan diri.'},
                fizikal: { label: 'Fizikal', 'Tinggi': 'Anda merupakan individu yang sangat konsisten mengamalkan penjagaan kesihatan fizikal. Anda sentiasa mengamalkan tabiat harian dan tingkah laku yang memberikan kesan yang baik kepada kesihatan (amalan pemakanan, nutrisi seimbang, riadah dan aktiviti fizikal serta penjagaan kebersihan diri). Anda sentiasa mengamalkan gaya hidup yang sihat.', 'Sederhana Tinggi': 'Anda merupakan individu yang mengamalkan penjagaan kesihatan fizikal yang baik. Anda konsisten mengamalkan tabiat harian dan tingkah laku yang memberikan kesan baik kepada kesihatan (amalan pemakanan, nutrisi seimbang, riadah dan aktiviti fizikal serta penjagaan kebersihan diri). Anda mengamalkan gaya hidup yang sihat.', 'Sederhana': 'Anda merupakan individu yang mengamalkan penjagaan kesihatan fizikal. Anda agak konsisten dalam mengamalkan tabiat harian dan tingkah laku yang memberikan kesan kepada kesihatan (amalan pemakanan, nutrisi seimbang, riadah dan aktiviti fizikal serta penjagaan kebersihan diri). Anda mengamalkan gaya hidup yang agak sihat.', 'Sederhana Rendah': 'Anda merupakan individu yang kurang mengamalkan penjagaan kesihatan fizikal. Anda kurang konsisten dalam mengamalkan tabiat harian dan tingkah laku yang memberikan kesan kepada kesihatan (amalan pemakanan, nutrisi seimbang, riadah dan aktiviti fizikal serta penjagaan kebersihan diri). Anda mengamalkan gaya hidup yang kurang sihat.', 'Rendah': 'Anda merupakan individu yang sangat kurang mengamalkan penjagaan kesihatan fizikal. Anda tidak konsisten dalam mengamalkan tabiat harian dan tingkah laku yang memberikan kesan kepada kesihatan (amalan pemakanan, nutrisi seimbang, riadah dan aktiviti fizikal serta penjagaan kebersihan diri). Anda mengamalkan gaya hidup yang sangat kurang sihat.'},
                perhubungan: { label: 'Perhubungan', 'Tinggi': 'Anda sentiasa menjaga dan memanfaatkan kualiti perhubungan dua hala antara individu dan orang lain dalam kalangan ahli keluarga, rakan sebaya dan komuniti.', 'Sederhana Tinggi': 'Anda menjaga dan memanfaatkan kualiti perhubungan dua hala antara individu dan orang lain dalam kalangan ahli keluarga, rakan sebaya dan komuniti.', 'Sederhana': 'Anda agak berupaya menjaga dan memanfaatkan kualiti perhubungan dua hala antara individu dan orang lain dalam kalangan ahli keluarga, rakan sebaya dan komuniti.', 'Sederhana Rendah': 'Anda kurang berupaya menjaga dan memanfaatkan kualiti perhubungan dua hala antara individu dan orang lain dalam kalangan ahli keluarga, rakan sebaya dan komuniti.', 'Rendah': 'Anda sangat kurang berupaya menjaga dan memanfaatkan kualiti perhubungan dua hala antara individu dan orang lain dalam kalangan ahli keluarga, rakan sebaya dan komuniti.'},
                intelektual: { label: 'Intelektual', 'Tinggi': 'Anda memiliki kebolehan berfikir secara rasional yang tinggi. Anda seorang yang sangat kreatif dalam menyelesaikan masalah. Anda juga sentiasa berusaha untuk menambah ilmu pengetahuan. Keupayaan yang sangat baik untuk menganalisis dan mempertimbangkan pilihan-pilihan yang sesuai.', 'Sederhana Tinggi': 'Anda memiliki kebolehan berfikir secara rasional yang baik. Anda seorang yang kreatif dalam menyelesaikan masalah. Anda juga berusaha untuk menambah ilmu pengetahuan. Keupayaan yang baik untuk menganalisis dan mempertimbangkan pilihan-pilihan yang sesuai.', 'Sederhana': 'Anda memiliki kebolehan berfikir secara rasional yang agak baik. Anda seorang yang agak kreatif dalam menyelesaikan masalah. Anda juga agak berusaha untuk menambah ilmu pengetahuan. Keupayaan yang agak baik untuk menganalisis dan mempertimbangkan pilihan-pilihan yang sesuai.', 'Sederhana Rendah': 'Anda memiliki kebolehan berfikir secara rasional yang rendah. Anda seorang yang kurang kreatif dalam menyelesaikan masalah. Anda juga kurang berusaha untuk menambah ilmu pengetahuan. Keupayaan yang rendah untuk menganalisis dan mempertimbangkan pilihan-pilihan yang sesuai.', 'Rendah': 'Anda memiliki kebolehan berfikir secara rasional yang sangat rendah. Anda seorang yang sangat tidak kreatif dalam menyelesaikan masalah. Anda juga sangat tidak berusaha untuk menambah ilmu pengetahuan. Keupayaan yang sangat rendah untuk menganalisis dan mempertimbangkan pilihan-pilihan yang sesuai.'},
                spiritual: { label: 'Spiritual', 'Tinggi': 'Anda mempunyai pegangan nilai-nilai murni dan kepercayaan yang sangat tinggi. Anda sangat berupaya menghayati dan mengamalkan nilai-nilai murni dalam kehidupan. Anda sentiasa menunjukkan integriti yang tinggi dalam kehidupan.', 'Sederhana Tinggi': 'Anda mempunyai pegangan nilai-nilai murni dan kepercayaan yang tinggi. Anda berupaya menghayati dan mengamalkan nilai-nilai murni dalam kehidupan. Anda menunjukkan integriti yang tinggi dalam kehidupan.', 'Sederhana': 'Anda mempunyai pegangan nilai-nilai murni dan kepercayaan yang agak tinggi. Anda agak berupaya menghayati dan mengamalkan nilai-nilai murni dalam kehidupan. Anda agak menunjukkan integriti yang tinggi dalam kehidupan.', 'Sederhana Rendah': 'Anda mempunyai pegangan nilai-nilai murni dan kepercayaan yang rendah. Anda kurang berupaya menghayati dan mengamalkan nilai-nilai murni dalam kehidupan. Anda kurang menunjukkan integriti yang tinggi dalam kehidupan.', 'Rendah': 'Anda mempunyai pegangan nilai-nilai murni dan kepercayaan yang sangat rendah. Anda sangat kurang berupaya menghayati dan mengamalkan nilai-nilai murni dalam kehidupan. Anda sangat kurang menunjukkan integriti yang tinggi dalam kehidupan.'},
                identiti: { label: 'Identiti', 'Tinggi': 'Anda mempunyai penerimaan diri yang sangat tinggi terhadap jantina, budaya dan kompetensi diri. Anda berasa sangat selesa dengan identiti diri.', 'Sederhana Tinggi': 'Anda mempunyai penerimaan diri yang tinggi terhadap jantina, budaya dan kompetensi diri. Anda berasa selesa dengan identiti diri.', 'Sederhana': 'Anda mempunyai penerimaan diri yang agak tinggi terhadap jantina, budaya dan kompetensi diri. Anda berasa agak selesa dengan identiti diri.', 'Sederhana Rendah': 'Anda mempunyai penerimaan diri yang rendah terhadap jantina, budaya dan kompetensi diri. Anda berasa kurang selesa dengan identiti diri.', 'Rendah': 'Anda mempunyai penerimaan diri yang sangat rendah terhadap jantina, budaya dan kompetensi diri. Anda berasa sangat tidak selesa dengan identiti diri.'},
                kewangan: { label: 'Kewangan', 'Tinggi': 'Anda mempunyai pengetahuan dan kemahiran yang sangat tinggi dalam menguruskan kewangan. Anda sangat berupaya untuk membuat keputusan kewangan yang bijak.', 'Sederhana Tinggi': 'Anda mempunyai pengetahuan dan kemahiran yang tinggi dalam menguruskan kewangan. Anda berupaya untuk membuat keputusan kewangan yang bijak.', 'Sederhana': 'Anda mempunyai pengetahuan dan kemahiran yang agak tinggi dalam menguruskan kewangan. Anda agak berupaya untuk membuat keputusan kewangan yang bijak.', 'Sederhana Rendah': 'Anda mempunyai pengetahuan dan kemahiran yang rendah dalam menguruskan kewangan. Anda kurang berupaya untuk membuat keputusan kewangan yang bijak.', 'Rendah': 'Anda mempunyai pengetahuan dan kemahiran yang sangat rendah dalam menguruskan kewangan. Anda sangat tidak berupaya untuk membuat keputusan kewangan yang bijak.'}
            }
        };

        async function createPDF(outputType = 'download') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
            const pageHeight = doc.internal.pageSize.getHeight();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 40;
            let yPos = margin;

            // --- DATA PREPARATION ---
            const personalityScores = calculatePersonalityScores();
            const ikpsiScores = calculateIkpsiScores();
            const demographics = state.responses.demographics;
            const guardianDemographics = state.responses.guardianDemographics;

            const getPersonalityTahap = (score) => (score >= 67 ? 'Tinggi' : score >= 34 ? 'Sederhana' : 'Rendah');
            const getIkpsiPercent = (score, totalItems) => Math.round(((score - totalItems) / (totalItems * 4)) * 100);
            const getIkpsiTahap = (percent) => {
                if (percent >= 80) return 'Tinggi';
                if (percent >= 60) return 'Sederhana Tinggi';
                if (percent >= 40) return 'Sederhana';
                if (percent >= 20) return 'Sederhana Rendah';
                return 'Rendah';
            };
            const getKeselarasanTahap = (score) => (score <= 20 ? 'Selaras' : 'Tidak Selaras');

            const ikpsiPercentScores = {};
            let totalIkpsiPercentSum = 0;
            for (const key in ikpsiScoring.domains) {
                const domain = ikpsiScoring.domains[key];
                const score = ikpsiScores[key];
                const percent = getIkpsiPercent(score, domain.items.length);
                ikpsiPercentScores[key] = percent;
                totalIkpsiPercentSum += percent;
            }
            const overallWellbeingPercent = Math.round(totalIkpsiPercentSum / Object.keys(ikpsiScoring.domains).length);
            const overallWellbeingTahap = getIkpsiTahap(overallWellbeingPercent);

            // --- HELPER FUNCTIONS FOR PDF ---
            const addHeader = (title) => {
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(title, pageWidth / 2, yPos, { align: 'center' });
                yPos += 25;
            };

            const addSubHeader = (title) => {
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(title, margin, yPos);
                yPos += 15;
            };

            const addPageNumbers = () => {
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'italic');
                    doc.text(`Halaman ${i} dari ${pageCount}`, pageWidth - margin, pageHeight - 15, { align: 'right' });
                }
            };

            const checkPageBreak = (spaceNeeded) => {
                if (yPos + spaceNeeded > pageHeight - margin) {
                    doc.addPage();
                    yPos = margin;
                }
            };

            // --- PDF CONTENT ---
            // Page 1: Title and Demographics
            addHeader('LAPORAN PROFIL PERSONALITI DAN KESEJAHTERAAN PELAJAR');
            doc.setLineWidth(1.5);
            doc.line(margin, yPos - 15, pageWidth - margin, yPos - 15);

            addSubHeader('BAHAGIAN A: MAKLUMAT PELAJAR');
            doc.autoTable({
                startY: yPos,
                theme: 'grid',
                body: [
                    ['Nama Penuh', demographics.name || ''],
                    ['No. MyKad', demographics.ic || ''],
                    ['Emel', demographics.email || ''],
                    ['Jantina', demographics.gender || ''],
                    ['Bangsa', demographics.race || ''],
                    ['Agama', demographics.religion || ''],
                    ['No. Telefon', demographics.phone || ''],
                    ['IPG Kampus', demographics.ipgKampus || ''],
                    ['Program', demographics.program || ''],
                    ['Semester', demographics.semester || ''],
                ],
                styles: { fontSize: 9, cellPadding: 4 },
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 150 } },
                didDrawPage: (data) => { yPos = data.cursor.y; }
            });
            yPos += 15;

            addSubHeader('BAHAGIAN B: MAKLUMAT PENJAGA');
            doc.autoTable({
                startY: yPos,
                theme: 'grid',
                body: [
                    ['Nama Ibu/Bapa/Penjaga', guardianDemographics.guardian_name || ''],
                    ['No. Telefon Penjaga', guardianDemographics.guardian_phone || ''],
                    ['Alamat Penuh', guardianDemographics.guardian_address || ''],
                    ['Pendapatan Isi Rumah', guardianDemographics.guardian_income || ''],
                ],
                styles: { fontSize: 9, cellPadding: 4 },
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 150 } },
                didDrawPage: (data) => { yPos = data.cursor.y; }
            });
            yPos = doc.autoTable.previous.finalY + 20;

            // Page 2: Personality Profile
            doc.addPage();
            yPos = margin;
            addHeader('BAHAGIAN C: PERSONALITI PELAJAR');

            // Add Personality Chart (Optimized for size)
            const personalityChartCanvas = document.getElementById('personality-chart');
            const personalityChartImage = await html2canvas(personalityChartCanvas, { scale: 1, backgroundColor: '#ffffff' });
            const personalityChartImageData = personalityChartImage.toDataURL('image/jpeg', 0.7); // Use JPEG with 70% quality
            const chartWidth = 450;
            const chartHeight = (personalityChartImage.height * chartWidth) / personalityChartImage.width;
            checkPageBreak(chartHeight + 20);
            doc.addImage(personalityChartImageData, 'JPEG', (pageWidth - chartWidth) / 2, yPos, chartWidth, chartHeight);
            yPos += chartHeight + 20;

            // Add Personality Table
            const personalityTableBody = Object.keys(personalityScores).map(key => {
                const score = personalityScores[key];
                const tahap = getPersonalityTahap(score);
                const interp = interpretations.personality[key][tahap];
                return [interpretations.personality[key].label, `${score}%`, tahap, interp];
            });

            checkPageBreak(150);
            doc.autoTable({
                startY: yPos,
                head: [['Dimensi', 'Skor', 'Tahap', 'Interpretasi']],
                body: personalityTableBody,
                theme: 'striped',
                headStyles: { fillColor: [22, 160, 133], fontSize: 10 },
                styles: { fontSize: 9, cellPadding: 5, valign: 'middle' },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 80 },
                    1: { cellWidth: 40, halign: 'center' },
                    2: { cellWidth: 60, halign: 'center' },
                    3: { cellWidth: 'auto' }
                },
                didDrawPage: (data) => { yPos = data.cursor.y; }
            });
            yPos = doc.autoTable.previous.finalY + 20;


            // Page 3: Wellbeing Profile
            doc.addPage();
            yPos = margin;
            addHeader('BAHAGIAN D: KESEJAHTERAAN PELAJAR (IKPsi-P)');

            // Add IKPSI Chart (Optimized for size)
            const ikpsiChartCanvas = document.getElementById('ikpsi-chart');
            const ikpsiChartImage = await html2canvas(ikpsiChartCanvas, { scale: 1, backgroundColor: '#ffffff' });
            const ikpsiChartImageData = ikpsiChartImage.toDataURL('image/jpeg', 0.7); // Use JPEG with 70% quality
            checkPageBreak(chartHeight + 20);
            doc.addImage(ikpsiChartImageData, 'JPEG', (pageWidth - chartWidth) / 2, yPos, chartWidth, chartHeight);
            yPos += chartHeight + 20;

            // Add IKPSI Table
            const ikpsiTableBody = Object.keys(ikpsiScoring.domains).map(key => {
                const score = ikpsiScores[key];
                const domain = ikpsiScoring.domains[key];
                const percent = getIkpsiPercent(score, domain.items.length);
                const tahap = getIkpsiTahap(percent);
                const interp = interpretations.ikpsi[key][tahap];
                return [domain.label, `${percent}%`, tahap, interp];
            });

            checkPageBreak(200);
            doc.autoTable({
                startY: yPos,
                head: [['Konstruk', 'Skor', 'Tahap', 'Interpretasi']],
                body: ikpsiTableBody,
                theme: 'striped',
                headStyles: { fillColor: [41, 128, 185], fontSize: 10 },
                styles: { fontSize: 8, cellPadding: 4, valign: 'middle' },
                 columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 60 },
                    1: { cellWidth: 40, halign: 'center' },
                    2: { cellWidth: 80, halign: 'center' },
                    3: { cellWidth: 'auto' }
                },
                didDrawPage: (data) => { yPos = data.cursor.y; }
            });
            yPos = doc.autoTable.previous.finalY + 20;


            // Page 4: Summary and Recommendations
            doc.addPage();
            yPos = margin;
            addHeader('RUMUSAN DAN CADANGAN');

            // Overall Wellbeing
            addSubHeader('Rumusan Kesejahteraan Keseluruhan');
            doc.autoTable({
                startY: yPos,
                theme: 'grid',
                body: [
                    ['Skor Keseluruhan', `${overallWellbeingPercent}%`],
                    ['Tahap Keseluruhan', overallWellbeingTahap]
                ],
                styles: { fontSize: 10, cellPadding: 5 },
                columnStyles: { 0: { fontStyle: 'bold' } }
            });
            yPos = doc.autoTable.previous.finalY + 20;

            // Consistency Check
            addSubHeader('Semakan Keselarasan Jawapan');
            const keselarasanTahap = getKeselarasanTahap(ikpsiScores.keselarasan);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Skor Keselarasan: ${ikpsiScores.keselarasan}`, margin, yPos);
            yPos += 15;
            doc.text(`Tahap: ${keselarasanTahap}`, margin, yPos);
            yPos += 20;
            const consistencyText = keselarasanTahap === 'Selaras'
                ? 'Anda mempunyai kecenderungan menjawab item-item secara konsisten'
                : 'Anda mempunyai kecenderungan menjawab item-item secara tidak konsisten.';
            doc.text(consistencyText, margin, yPos, { maxWidth: pageWidth - (margin * 2) });
            yPos += 50;


            // Recommendations
            checkPageBreak(150);
            addSubHeader('Cadangan');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const recommendations = [
                'Laporan ini adalah untuk rujukan peribadi. Ia memberi gambaran umum tentang personaliti dan tahap kesejahteraan anda pada masa ini.',
                'Fokus pada konstruk kesejahteraan dengan skor "Rendah" atau "Sederhana Rendah". Rancang tindakan kecil untuk meningkatkan aspek tersebut.',
                'Jika anda mengalami tekanan atau memerlukan sokongan, sila berhubung dengan Kaunselor di Unit Psikologi dan Kaunseling IPG Kampus anda.',
                'Gunakan kekuatan personaliti anda untuk menyokong pembelajaran dan perhubungan anda. Contohnya, jika anda tinggi dalam "Extraversion", libatkan diri dalam aktiviti kumpulan.',
                'Jika skor "Neuroticism" anda tinggi, pelajari teknik pengurusan stres seperti meditasi atau senaman pernafasan.'
            ];
            recommendations.forEach(rec => {
                doc.text(`â€¢ ${rec}`, margin + 10, yPos, { maxWidth: pageWidth - (margin * 2) - 10 });
                yPos += 30;
                checkPageBreak(30);
            });

            // Disclaimer
            yPos = pageHeight - 60;
            doc.setFontSize(8);
            doc.setFont('helvetica', 'italic');
            doc.text('Penafian: Laporan ini dijana secara automatik berdasarkan jawapan yang diberikan oleh pelajar. Ia bukan satu diagnosis klinikal. Untuk maklumat lanjut, sila rujuk kaunselor bertauliah.',
                pageWidth / 2, yPos, { align: 'center', maxWidth: pageWidth - (margin * 2) }
            );


            // Finalize PDF
            addPageNumbers();
            if (outputType === 'download') {
                doc.save(`Laporan_Profil_${demographics.name.replace(/ /g, '_')}.pdf`);
            } else {
                return doc.output(outputType);
            }
        }

        // --- UI RENDERING ---
        function render() {
            const app = document.getElementById('app');
            app.className = 'max-w-4xl w-full mx-auto bg-white shadow-lg rounded-lg pb-24'; // Added pb-24 for footer spacing
            
            if (state.isAdminView && state.isAdminLoggedIn) {
                app.innerHTML = renderAdminView();
            } else if (state.showResults) {
                app.innerHTML = renderResultsPage();
                setTimeout(() => renderCharts(), 100);
            } else if (state.currentSection === -1) {
                app.innerHTML = renderWelcomeScreen();
            } else {
                let content = '<div class="p-4 sm:p-6 lg:p-8">';
                const totalSections = 4;
                const progress = ((state.currentSection + 1) / totalSections) * 100;

                content += renderProgressBar(progress, state.currentSection, totalSections);

                if (state.currentSection === 0) {
                    content += renderDemographicsForm();
                } else if (state.currentSection === 1) {
                    content += renderGuardianDemographicsForm();
                } else if (state.currentSection === 2) {
                    content += renderQuestions('personality', 'Bahagian C: Inventori Personaliti Big-Five (BFI)', personalityQuestions, state.responses.personality, handlePersonalityChange);
                } else if (state.currentSection === 3) {
                    content += renderQuestions('ikpsi', 'Bahagian D: Inventori Kesejahteraan Psikologi Siswa Pendidik (IKPSI-P)', ikpsiQuestions, state.responses.ikpsi, handleIkpsiChange);
                }

                content += renderNavigationButtons(state.currentSection, totalSections);
                content += '</div>';
                app.innerHTML = content;

                if (state.currentSection === 0) {
                    updateICCounter(state.responses.demographics.ic || '');
                }
            }
        }

        function renderWelcomeScreen() {
            return `
                <div class="p-8 sm:p-10 text-left">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">Profil Kesejahteraan & Personaliti Pelajar</h1>
                    <p class="text-gray-600 mb-6">
                        Soal selidik ini bertujuan untuk membantu anda memahami profil kesejahteraan psikologi dan personaliti anda. Maklum balas anda adalah SULIT dan akan digunakan untuk tujuan pembangunan diri.
                    </p>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-8">
                        <h2 class="font-bold text-lg text-blue-800 mb-2">Arahan Penting:</h2>
                        <ul class="list-disc list-inside space-y-2 text-gray-700">
                            <li>Jawab semua soalan dengan jujur dan ikhlas.</li>
                            <li>Tiada jawapan yang betul atau salah.</li>
                            <li>Anggaran masa menjawab adalah 15-20 minit.</li>
                            <li>Anda digalakkan untuk memuat turun keputusan secara manual setelah selesai menjawab.</li>
                        </ul>
                    </div>
                    <div class="text-center">
                        <button data-action="start-survey" class="bg-blue-600 text-white font-bold py-3 px-12 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                            Mula Jawab
                        </button>
                    </div>
                </div>
            `;
        }

        function renderProgressBar(progress, current, total) {
            const sectionNames = ['Maklumat Diri', 'Maklumat Penjaga', 'Personaliti', 'Kesejahteraan'];
            return `
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-700 mb-1">Langkah ${current + 1} dari ${total}</h2>
                    <p class="text-gray-500 mb-3">${sectionNames[current]}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full progress-bar-animated" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
        }

        function renderDemographicsForm() {
            let formHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-6">Bahagian A: Maklumat Demografi</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;
            demographicsQuestions.forEach(q => {
                const value = state.responses.demographics[q.id] || '';
                if (q.type === 'select') {
                    formHTML += `
                        <div class="col-span-1">
                            <label for="${q.id}" class="block text-sm font-medium text-gray-700 mb-1">${q.label}</label>
                            <select id="${q.id}" onchange="handleDemographicChange('${q.id}', this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" ${q.required ? 'required' : ''}>
                                <option value="" disabled ${value === '' ? 'selected' : ''}>Sila pilih...</option>
                                ${q.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else {
                    formHTML += `
                        <div class="col-span-1 relative">
                            <label for="${q.id}" class="block text-sm font-medium text-gray-700 mb-1">${q.label}</label>
                            <input type="${q.type}" id="${q.id}" value="${value}" oninput="handleDemographicChange('${q.id}', this.value)"
                                   class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                   ${q.required ? 'required' : ''} ${q.maxLength ? `maxlength="${q.maxLength}"` : ''} ${q.pattern ? `pattern="${q.pattern}"` : ''}>
                            ${q.id === 'ic' ? '<span id="ic-counter" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm pointer-events-none"></span>' : ''}
                        </div>
                    `;
                }
            });
            formHTML += `</div>`;
            return formHTML;
        }

        function renderGuardianDemographicsForm() {
            let formHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-6">Bahagian B: Maklumat Ibu/Bapa/Penjaga</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;
            guardianDemographicsQuestions.forEach(q => {
                const value = state.responses.guardianDemographics[q.id] || '';
                if (q.type === 'select') {
                     formHTML += `
                        <div class="col-span-1 md:col-span-2">
                            <label for="${q.id}" class="block text-sm font-medium text-gray-700 mb-1">${q.label}</label>
                            <select id="${q.id}" onchange="handleGuardianDemographicChange('${q.id}', this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" ${q.required ? 'required' : ''}>
                                <option value="" disabled ${value === '' ? 'selected' : ''}>Sila pilih...</option>
                                ${q.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;
                } else if (q.type === 'textarea') {
                    formHTML += `
                        <div class="col-span-1 md:col-span-2">
                            <label for="${q.id}" class="block text-sm font-medium text-gray-700 mb-1">${q.label}</label>
                            <textarea id="${q.id}" oninput="handleGuardianDemographicChange('${q.id}', this.value)"
                                   class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                   rows="3" ${q.required ? 'required' : ''}>${value}</textarea>
                        </div>
                    `;
                } else {
                     formHTML += `
                        <div class="col-span-1">
                            <label for="${q.id}" class="block text-sm font-medium text-gray-700 mb-1">${q.label}</label>
                            <input type="${q.type}" id="${q.id}" value="${value}" oninput="handleGuardianDemographicChange('${q.id}', this.value)"
                                   class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                   ${q.required ? 'required' : ''}>
                        </div>
                    `;
                }
            });
            formHTML += `</div>`;
            return formHTML;
        }

        function renderQuestions(type, title, questions, responses, handler) {
            const options = [
                { value: 1, label: 'Sangat Tidak Setuju' },
                { value: 2, label: 'Tidak Setuju' },
                { value: 3, label: 'Neutral' },
                { value: 4, label: 'Setuju' },
                { value: 5, label: 'Sangat Setuju' }
            ];

            let questionsHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-2">${title}</h2>`;
            questionsHTML += `<p class="text-gray-600 mb-6">Sila tandakan jawapan anda pada skala 1 hingga 5.</p>`;

            // Sticky header for options
            questionsHTML += `
                <div class="sticky top-0 bg-white py-3 z-10 hidden md:grid grid-cols-[1fr,250px] gap-4 border-b-2 border-gray-200 mb-4">
                     <div class="font-semibold text-gray-600">Penyataan</div>
                     <div class="grid grid-cols-5 gap-2 text-center font-semibold text-gray-600 text-xs">
                        ${options.map(o => `<div>${o.label}</div>`).join('')}
                     </div>
                </div>
            `;

            questions.forEach((q, index) => {
                const selectedValue = responses[index];
                questionsHTML += `
                    <div class="grid grid-cols-1 md:grid-cols-[1fr,250px] gap-4 py-4 border-b border-gray-200 items-center">
                        <p class="text-gray-800">${index + 1}. ${q}</p>
                        <div class="flex justify-around items-center radio-container">
                            ${options.map(opt => `
                                <div>
                                    <input type="radio" id="${type}-${index}-${opt.value}" name="${type}-${index}" value="${opt.value}" class="sr-only" onchange="${handler.name}(${index}, this.value)" ${selectedValue === opt.value ? 'checked' : ''}>
                                    <label for="${type}-${index}-${opt.value}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 cursor-pointer ${selectedValue === opt.value ? (type === 'personality' ? 'bg-blue-500' : 'bg-green-500') + ' text-white shadow-lg transform scale-110' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}">
                                        ${opt.value}
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            return questionsHTML;
        }

        function renderNavigationButtons(current, total) {
            let navHTML = `<div class="mt-8 flex justify-between items-center">`;
            if (current > 0) {
                navHTML += `<button data-action="prev-section" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition duration-300">Kembali</button>`;
            } else {
                navHTML += `<div></div>`; // Placeholder for alignment
            }

            if (current < total - 1) {
                navHTML += `<button data-action="next-section" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300">Seterusnya</button>`;
            } else {
                navHTML += `<button data-action="show-results" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300">Hantar & Lihat Keputusan</button>`;
            }
            navHTML += `</div>`;
            return navHTML;
        }

        function renderResultsPage() {
            const personalityScores = calculatePersonalityScores();
            const ikpsiScores = calculateIkpsiScores();
            const demographics = state.responses.demographics;

            const getPersonalityTahap = (score) => (score >= 67 ? 'Tinggi' : score >= 34 ? 'Sederhana' : 'Rendah');
            const getIkpsiPercent = (score, totalItems) => Math.round(((score - totalItems) / (totalItems * 4)) * 100);
            const getIkpsiTahap = (percent) => {
                if (percent >= 80) return 'Tinggi';
                if (percent >= 60) return 'Sederhana Tinggi';
                if (percent >= 40) return 'Sederhana';
                if (percent >= 20) return 'Sederhana Rendah';
                return 'Rendah';
            };

            return `
                <div id="results-container" class="p-4 sm:p-6 lg:p-8">
                    <div class="text-center mb-10">
                        <h1 class="text-3xl font-bold text-gray-800">Laporan Keputusan Anda</h1>
                        <p class="text-gray-600 mt-2">Berikut adalah rumusan profil personaliti dan kesejahteraan anda, ${demographics.name}.</p>
                    </div>

                    <div class="flex justify-center gap-4 mb-10 no-print">
                        <button data-action="download-pdf" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition duration-300 shadow-md flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            Muat Turun PDF
                        </button>
                        <button data-action="new-survey" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition duration-300 shadow-md flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.899 2.139l.832-1.876A1 1 0 0119 6.225V9a1 1 0 01-1 1h-2.775a1 1 0 01-.866-1.5l.832-1.877a5.002 5.002 0 00-8.583-1.612V5a1 1 0 01-1-1H4zM2 10a1 1 0 011-1h2.775a1 1 0 01.866 1.5l-.832 1.877a5.002 5.002 0 008.583 1.612V15a1 1 0 011 1h1a1 1 0 01-1 1v-2.101a7.002 7.002 0 01-11.899-2.139l-.832 1.876A1 1 0 011 13.775V11a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Mula Semula
                        </button>
                    </div>

                    <!-- Personality Section -->
                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm mb-8">
                        <h2 class="text-2xl font-bold text-blue-800 mb-4">Profil Personaliti (Big Five)</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                            <div>
                                <canvas id="personality-chart" width="400" height="400"></canvas>
                            </div>
                            <div>
                                <ul class="space-y-3">
                                    ${Object.keys(personalityScores).map(key => `
                                        <li class="p-3 bg-white rounded-md border border-gray-200">
                                            <div class="flex justify-between items-center">
                                                <span class="font-semibold text-gray-700">${interpretations.personality[key].label}</span>
                                                <span class="font-bold text-blue-600">${personalityScores[key]}%</span>
                                            </div>
                                            <p class="text-sm text-gray-500 mt-1">${interpretations.personality[key][getPersonalityTahap(personalityScores[key])]}</p>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Wellbeing Section -->
                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-bold text-green-800 mb-4">Profil Kesejahteraan (IKPSI-P)</h2>
                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                            <div>
                                <canvas id="ikpsi-chart" width="400" height="400"></canvas>
                            </div>
                            <div>
                                <ul class="space-y-2">
                                     ${Object.keys(ikpsiScoring.domains).map(key => {
                                        const domain = ikpsiScoring.domains[key];
                                        const score = ikpsiScores[key];
                                        const percent = getIkpsiPercent(score, domain.items.length);
                                        const tahap = getIkpsiTahap(percent);
                                        return `
                                            <li class="p-3 bg-white rounded-md border border-gray-200">
                                                <div class="flex justify-between items-center">
                                                    <span class="font-semibold text-gray-700">${domain.label}</span>
                                                    <span class="font-bold text-green-600">${tahap} (${percent}%)</span>
                                                </div>
                                            </li>
                                        `
                                     }).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderAdminView() {
            let tableRows = allResponsesData.map((data, index) => {
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 text-center">${index + 1}</td>
                        <td class="p-3">${data.demographics.name || ''}</td>
                        <td class="p-3">${data.demographics.email || ''}</td>
                        <td class="p-3">${data.demographics.ipgKampus || ''}</td>
                        <td class="p-3">${data.timestamp}</td>
                    </tr>
                `;
            }).join('');

            if (allResponsesData.length === 0) {
                tableRows = `<tr><td colspan="5" class="text-center p-6 text-gray-500">Tiada data responden yang telah direkodkan.</td></tr>`;
            }

            return `
                <div class="p-4 sm:p-6 lg:p-8 fade-in">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Paparan Admin - Data Responden</h1>
                        <div>
                            <button data-action="export-csv" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 mr-2">
                                Eksport CSV
                            </button>
                            <button data-action="exit-admin" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition duration-300">
                                Kembali
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto bg-white rounded-lg shadow">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 text-center">#</th>
                                    <th class="p-3">Nama</th>
                                    <th class="p-3">Emel</th>
                                    <th class="p-3">IPG Kampus</th>
                                    <th class="p-3">Tarikh Jawab</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }


        function renderCharts() {
            // Personality Chart (Bar Chart)
            const personalityCtx = document.getElementById('personality-chart')?.getContext('2d');
            if (personalityCtx) {
                const personalityScores = calculatePersonalityScores();
                new Chart(personalityCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(personalityScores).map(k => interpretations.personality[k].label),
                        datasets: [{
                            label: 'Skor Personaliti (%)',
                            data: Object.values(personalityScores),
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.6)',
                                'rgba(26, 188, 156, 0.6)',
                                'rgba(241, 196, 15, 0.6)',
                                'rgba(231, 76, 60, 0.6)',
                                'rgba(155, 89, 182, 0.6)'
                            ],
                            borderColor: [
                                'rgb(59, 130, 246)',
                                'rgb(26, 188, 156)',
                                'rgb(241, 196, 15)',
                                'rgb(231, 76, 60)',
                                'rgb(155, 89, 182)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // IKPSI Chart (Radar Chart)
            const ikpsiCtx = document.getElementById('ikpsi-chart')?.getContext('2d');
            if (ikpsiCtx) {
                const ikpsiScores = calculateIkpsiScores();
                const getIkpsiPercent = (score, totalItems) => Math.round(((score - totalItems) / (totalItems * 4)) * 100);
                const chartData = Object.keys(ikpsiScoring.domains).map(key => {
                    const domain = ikpsiScoring.domains[key];
                    const score = ikpsiScores[key];
                    return getIkpsiPercent(score, domain.items.length);
                });

                new Chart(ikpsiCtx, {
                    type: 'radar',
                    data: {
                        labels: Object.values(ikpsiScoring.domains).map(d => d.label),
                        datasets: [{
                            label: 'Skor Kesejahteraan (%)',
                            data: chartData,
                            backgroundColor: 'rgba(39, 174, 96, 0.2)',
                            borderColor: 'rgba(39, 174, 96, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(39, 174, 96, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(39, 174, 96, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                pointLabels: {
                                    font: {
                                        size: 10
                                    }
                                },
                                ticks: {
                                    backdropColor: 'transparent'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }

        // --- MODAL, LOGIN & CSV EXPORT ---
        function showModal(message) {
            const modalHTML = `
                <div id="alert-modal" class="modal-backdrop visible">
                    <div class="modal-content">
                        <h3 class="text-lg font-bold text-yellow-600 mb-4">Perhatian!</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button data-action="close-modal" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">OK</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modalHTML;
        }

        function showAdminLoginModal() {
            const modalHTML = `
                <div id="admin-login-modal" class="modal-backdrop visible">
                    <div class="modal-content">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Log Masuk Admin</h3>
                        <p class="text-gray-600 mb-4">Sila masukkan kata laluan untuk mengakses data responden.</p>
                        <input type="password" id="admin-password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm mb-2">
                        <p id="login-error" class="text-red-500 text-sm mb-4" style="display: none;">Kata laluan salah. Sila cuba lagi.</p>
                        <div class="flex gap-2 mt-4">
                            <button data-action="close-modal" class="w-full bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Batal</button>
                            <button data-action="submit-login" class="w-full bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Log Masuk</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modalHTML;
            document.getElementById('admin-password').focus();
        }
        
        function handleAdminLogin() {
            const correctPassword = "upskipgm2024"; // Updated password
            const passwordInput = document.getElementById('admin-password');
            const errorElement = document.getElementById('login-error');
            
            if (passwordInput.value === correctPassword) {
                state.isAdminLoggedIn = true;
                state.isAdminView = true;
                closeModal();
                render();
            } else {
                errorElement.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function closeModal() {
            const modal = document.querySelector('.modal-backdrop');
            if (modal) {
                modal.classList.remove('visible');
                setTimeout(() => {
                    document.getElementById('modal-container').innerHTML = '';
                }, 300);
            }
        }
        
        function exportToCSV() {
            if (allResponsesData.length === 0) {
                showModal("Tiada data untuk dieksport.");
                return;
            }

            const headers = [
                'Timestamp', 'Nama', 'MyKad', 'Emel', 'Jantina', 'Bangsa', 'Agama', 'Telefon', 'IPGK', 'Program', 'Semester',
                'NamaPenjaga', 'TelefonPenjaga', 'AlamatPenjaga', 'PendapatanPenjaga',
                'Extraversion', 'Agreeableness', 'Conscientiousness', 'Neuroticism', 'Openness',
                'SkorEmosi', 'SkorKendiri', 'SkorFizikal', 'SkorPerhubungan', 'SkorIntelektual', 'SkorSpiritual', 'SkorIdentiti', 'SkorKewangan', 'SkorKeselarasan'
            ];

            let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";

            allResponsesData.forEach(data => {
                const row = [
                    `"${data.timestamp}"`, `"${data.demographics.name || ''}"`, `"${data.demographics.ic || ''}"`, `"${data.demographics.email || ''}"`,
                    `"${data.demographics.gender || ''}"`, `"${data.demographics.race || ''}"`, `"${data.demographics.religion || ''}"`, `"${data.demographics.phone || ''}"`,
                    `"${data.demographics.ipgKampus || ''}"`, `"${data.demographics.program || ''}"`, `"${data.demographics.semester || ''}"`,
                    `"${data.guardianDemographics.guardian_name || ''}"`, `"${data.guardianDemographics.guardian_phone || ''}"`, `"${(data.guardianDemographics.guardian_address || '').replace(/"/g, '""')}"`, `"${data.guardianDemographics.guardian_income || ''}"`,
                    data.personalityScores.extraversion, data.personalityScores.agreeableness, data.personalityScores.conscientiousness, data.personalityScores.neuroticism, data.personalityScores.openness,
                    data.ikpsiScores.emosi, data.ikpsiScores.kendiri, data.ikpsiScores.fizikal, data.ikpsiScores.perhubungan, data.ikpsiScores.intelektual,
                    data.ikpsiScores.spiritual, data.ikpsiScores.identiti, data.ikpsiScores.kewangan, data.ikpsiScores.keselarasan
                ];
                csvContent += row.join(",") + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "data_responden_pkpp.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- RESET ---
        function resetState() {
             state = {
                ...state, // keep submittedEmails
                currentSection: -1,
                showResults: false,
                isAdminView: false,
                isAdminLoggedIn: false, // Reset login status
                responses: {
                    demographics: {},
                    guardianDemographics: {},
                    personality: {},
                    ikpsi: {}
                }
            };
            render();
            window.scrollTo(0, 0);
        }

        // --- INITIALIZATION & EVENT LISTENER ---
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', async (e) => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                if (!action) return;
                
                e.preventDefault();

                switch (action) {
                    case 'start-survey': startSurvey(); break;
                    case 'next-section': handleNextSection(); break;
                    case 'prev-section': handlePrevSection(); break;
                    case 'show-results': await showResults(); break;
                    case 'download-pdf':
                        e.target.disabled = true; e.target.textContent = 'Menjana PDF...';
                        try { await createPDF('download'); } 
                        catch (err) { console.error("PDF Generation Error:", err); showModal("Gagal menjana PDF. Sila cuba lagi."); } 
                        finally { e.target.disabled = false; e.target.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg> Muat Turun PDF`; }
                        break;
                    case 'new-survey': resetState(); break;
                    case 'close-modal': closeModal(); break;
                    case 'view-admin': showAdminLoginModal(); break;
                    case 'submit-login': handleAdminLogin(); break;
                    case 'exit-admin': state.isAdminView = false; state.isAdminLoggedIn = false; resetState(); break;
                    case 'export-csv': exportToCSV(); break;
                }
            });

            render();
        });
    </script>
</body>
</html>
