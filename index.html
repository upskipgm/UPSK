<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Kesejahteraan dan Personaliti Warga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { 
                font-size: 12px; 
                line-height: 1.3;
                margin: 0;
                padding: 10px;
            }
            .max-w-4xl { max-width: 100% !important; }
            .p-6 { padding: 8px !important; }
            .space-y-8 > * + * { margin-top: 12px !important; }
            .space-y-4 > * + * { margin-top: 8px !important; }
            .grid { display: block !important; }
            .lg\\:grid-cols-2 > * { 
                margin-bottom: 12px !important;
                page-break-inside: avoid;
            }
            table { 
                font-size: 11px;
                margin-bottom: 12px;
            }
            .text-3xl { font-size: 18px !important; }
            .text-xl { font-size: 14px !important; }
            .text-lg { font-size: 13px !important; }
            .mb-8 { margin-bottom: 12px !important; }
            .mb-6 { margin-bottom: 8px !important; }
            .mb-4 { margin-bottom: 6px !important; }
            .py-3 { padding-top: 3px !important; padding-bottom: 3px !important; }
            .px-3 { padding-left: 6px !important; padding-right: 6px !important; }
            .px-6 { padding-left: 8px !important; padding-right: 8px !important; }
            .py-3 { padding-top: 4px !important; padding-bottom: 4px !important; }
            .text-5xl { font-size: 24px !important; }
            .text-2xl { font-size: 16px !important; }
            .space-y-4 .bg-blue-100, .space-y-4 .bg-green-100 {
                padding: 6px !important;
                margin-top: 6px !important;
            }
            * { page-break-inside: avoid; }
            .grid.lg\\:grid-cols-2 { 
                display: flex !important; 
                flex-direction: row !important;
                gap: 12px !important;
            }
            .grid.lg\\:grid-cols-2 > div { 
                flex: 1 !important;
                max-width: 48% !important;
            }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-6 bg-white min-h-screen fade-in">
        <!-- Loading state -->
        <div class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Memuatkan soal selidik...</p>
        </div>
    </div>

    <script>
        // State management - using in-memory storage instead of localStorage
        let state = {
            currentSection: 0,
            showResults: false,
            responses: {
                demographics: {},
                personality: {},
                wellbeing: {}
            },
            submittedEmails: new Set() // Track submitted emails
        };

        // Demographics questions
        const demographicsQuestions = [
            { id: 'name', label: 'Nama Penuh', type: 'text', required: true },
            { id: 'ic', label: 'No. MyKad (Tanpa sempang)', type: 'text', required: true, maxLength: 12, pattern: '[0-9]*' },
            { id: 'email', label: 'Alamat Email', type: 'email', required: true },
            { id: 'gender', label: 'Jantina', type: 'select', options: ['Lelaki', 'Perempuan'], required: true },
            { id: 'race', label: 'Bangsa', type: 'select', options: ['Melayu', 'Cina', 'India', 'Bumiputera Sabah/Sarawak', 'Lain-lain'], required: true },
            { id: 'religion', label: 'Agama', type: 'select', options: ['Islam', 'Buddha', 'Kristian', 'Hindu', 'Lain-lain'], required: true },
            { id: 'phone', label: 'No. Telefon (Bimbit)', type: 'text', required: true },
            { 
                id: 'ipgKampus', 
                label: 'IPGM/IPGK', 
                type: 'select', 
                options: [
                    'Institut Pendidikan Guru Malaysia (IPGM)',
                    'IPG Kampus Bahasa Melayu',
                    'IPG Kampus Bahasa Antarabangsa',
                    'IPG Kampus Ilmu Khas',
                    'IPG Kampus Pendidikan Islam',
                    'IPG Kampus Pendidikan Teknik',
                    'IPG Kampus Raja Melewar',
                    'IPG Kampus Tun Hussein Onn',
                    'IPG Kampus Temenggong Ibrahim',
                    'IPG Kampus Perempuan Melayu Melaka',
                    'IPG Kampus Ipoh',
                    'IPG Kampus Pulau Pinang',
                    'IPG Kampus Tuanku Bainun',
                    'IPG Kampus Perlis',
                    'IPG Kampus Darul Aman',
                    'IPG Kampus Sultan Abdul Halim',
                    'IPG Kampus Tengku Ampuan Afzan',
                    'IPG Kampus Dato\' Razali Ismail',
                    'IPG Kampus Sultan Mizan',
                    'IPG Kampus Kota Bharu',
                    'IPG Kampus Kent',
                    'IPG Kampus Gaya',
                    'IPG Kampus Keningau',
                    'IPG Kampus Tawau',
                    'IPG Kampus Batu Lintang',
                    'IPG Kampus Sarawak',
                    'IPG Kampus Rajang',
                    'IPG Kampus Tun Abdul Razak',
                    'English Language Teaching Centre (ELTC)'
                ], 
                required: true 
            },
            { 
                id: 'jawatan', 
                label: 'Jawatan', 
                type: 'select', 
                options: [
                    'REKTOR',
                    'TIMBALAN REKTOR KANAN',
                    'TIMBALAN REKTOR',
                    'KETUA PENOLONG PENGARAH',
                    'PENOLONG PENGARAH',
                    'PENGARAH',
                    'TIMBALAN PENGARAH',
                    'PENSYARAH',
                    'KAUNSELOR',
                    'PEGAWAI PENGURUSAN',
                    'PEGAWAI GUNASAMA',
                    'ANGGOTA KHIDMAT PENGURUSAN (AKP)'
                ], 
                required: true 
            },
            { 
                id: 'gred', 
                label: 'Gred', 
                type: 'select', 
                options: [
                    'JUSA B',
                    'JUSA C',
                    'DG14',
                    'DG13',
                    'DG12',
                    'DG10',
                    'DG9',
                    'F10',
                    'F9',
                    'S10',
                    'S9',
                    'N2',
                    'N1'
                ], 
                required: true 
            }
        ];

        // Personality questions (44 items) - Updated from Word document
        const personalityQuestions = [
            'Saya melihat diri saya sebagai seorang yang bersikap terbuka',
            'Saya melihat diri saya sebagai seorang yang pemalu',
            'Saya melihat diri saya sebagai seorang yang penuh bertenaga',
            'Saya melihat diri saya sebagai seorang yang suka bersendirian',
            'Saya melihat diri saya sebagai seorang yang bercakap banyak',
            'Saya melihat diri saya sebagai seorang yang pendiam',
            'Saya melihat diri saya sebagai seorang yang berani',
            'Saya melihat diri saya sebagai seorang yang suka berkumpul',
            'Saya melihat diri saya sebagai seorang yang tidak mementingkan diri sendiri',
            'Saya melihat diri saya sebagai seorang yang suka mencari kesalahan orang lain',
            'Saya melihat diri saya sebagai seorang yang suka bergaduh',
            'Saya melihat diri saya sebagai seorang yang memaafkan',
            'Saya melihat diri saya sebagai seorang yang percaya kepada orang lain',
            'Saya melihat diri saya sebagai seorang yang boleh menjadi dingin (tidak peduli)',
            'Saya melihat diri saya sebagai seorang yang berhati mulia',
            'Saya melihat diri saya sebagai seorang yang baik kepada orang lain',
            'Saya melihat diri saya sebagai seorang yang suka bekerjasama',
            'Saya melihat diri saya sebagai seorang yang melakukan kerja dengan teliti',
            'Saya melihat diri saya sebagai seorang yang agak cuai',
            'Saya melihat diri saya sebagai seorang yang boleh dipercayai',
            'Saya melihat diri saya sebagai seorang yang tidak teratur',
            'Saya melihat diri saya sebagai seorang yang berdisiplin diri',
            'Saya melihat diri saya sebagai seorang yang suka menangguh kerja',
            'Saya melihat diri saya sebagai seorang yang bekerja dengan cekap',
            'Saya melihat diri saya sebagai seorang yang merancang dan mengikutinya',
            'Saya melihat diri saya sebagai seorang yang mudah teralih perhatian',
            'Saya melihat diri saya sebagai seorang yang dapat menangani tekanan',
            'Saya melihat diri saya sebagai seorang yang mudah tertekan',
            'Saya melihat diri saya sebagai seorang yang tidak mudah kecewa',
            'Saya melihat diri saya sebagai seorang yang murung',
            'Saya melihat diri saya sebagai seorang yang mudah risau',
            'Saya melihat diri saya sebagai seorang yang kadang-kadang berasa tertekan',
            'Saya melihat diri saya sebagai seorang yang mudah marah',
            'Saya melihat diri saya sebagai seorang yang emosi stabil',
            'Saya melihat diri saya sebagai seorang yang inventif (berdaya cipta)',
            'Saya melihat diri saya sebagai seorang yang suka mencuba perkara baharu',
            'Saya melihat diri saya sebagai seorang yang mempunyai imaginasi aktif',
            'Saya melihat diri saya sebagai seorang yang suka bermain dengan idea',
            'Saya melihat diri saya sebagai seorang yang artistik',
            'Saya melihat diri saya sebagai seorang yang suka kerja rutin',
            'Saya melihat diri saya sebagai seorang yang menghargai pengalaman artistik',
            'Saya melihat diri saya sebagai seorang yang konvensional, tradisional',
            'Saya melihat diri saya sebagai seorang yang kreatif',
            'Saya melihat diri saya sebagai seorang yang ingin tahu tentang banyak perkara'
        ];

        // Wellbeing questions (14 items) - Updated from Word document
        const wellbeingQuestions = [
            'Saya rasa optimistik mengenai masa depan',
            'Saya rasa berguna',
            'Saya rasa tenang',
            'Saya menangani masalah dengan baik',
            'Saya berfikir dengan jelas',
            'Saya rasa dekat dengan orang lain',
            'Saya boleh membuat keputusan sendiri',
            'Saya rasa baik tentang diri saya',
            'Saya berasa yakin',
            'Saya dapat menikmati aktiviti harian saya',
            'Saya boleh membuat keputusan terhadap sesuatu perkara',
            'Saya rasa disayangi',
            'Saya berminat dengan perkara baharu',
            'Saya rasa ceria'
        ];

        // Event handlers
        function handleDemographicChange(id, value) {
            if (id === 'ic') {
                const digitsOnly = value.replace(/\D/g, '');
                const limitedDigits = digitsOnly.slice(0, 12);
                state.responses.demographics[id] = limitedDigits;
            } else {
                state.responses.demographics[id] = value;
            }
            // Only update specific elements instead of full re-render for text inputs
            if (id === 'ic') {
                updateICCounter();
            }
        }

        function updateICCounter() {
            const counterElement = document.getElementById('ic-counter');
            if (counterElement && state.responses.demographics.ic) {
                const length = state.responses.demographics.ic.length;
                counterElement.innerHTML = `<span class="${length === 12 ? 'text-green-600' : 'text-red-500'}">(${length}/12)</span>`;
            }
        }

        function handlePersonalityChange(index, value) {
            state.responses.personality[index] = parseInt(value);
            // Don't re-render, just update the visual state
            updateRadioButtonVisual('personality', index, value);
        }

        function handleWellbeingChange(index, value) {
            state.responses.wellbeing[index] = parseInt(value);
            // Don't re-render, just update the visual state
            updateRadioButtonVisual('wellbeing', index, value);
        }

        function updateRadioButtonVisual(section, index, selectedValue) {
            // Update the visual state of radio buttons without re-rendering
            const buttons = document.querySelectorAll(`input[name="${section}-${index}"]`);
            buttons.forEach(button => {
                const container = button.nextElementSibling;
                if (parseInt(button.value) === parseInt(selectedValue)) {
                    if (section === 'personality') {
                        container.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 bg-blue-500 text-white shadow-lg transform scale-110';
                    } else {
                        container.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 bg-green-500 text-white shadow-lg transform scale-110';
                    }
                } else {
                    container.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 bg-gray-200 text-gray-600 hover:bg-gray-300';
                }
            });
        }

        function validateCurrentSection() {
            if (state.currentSection === 0) {
                const requiredFields = ['name', 'ic', 'email', 'gender', 'race', 'religion', 'phone', 'ipgKampus', 'jawatan', 'gred'];
                for (let field of requiredFields) {
                    const value = state.responses.demographics[field];
                    if (!value || value.toString().trim() === '') {
                        const fieldNames = {
                            name: 'Nama Penuh',
                            ic: 'No. MyKad',
                            email: 'Alamat Email',
                            gender: 'Jantina',
                            race: 'Bangsa',
                            religion: 'Agama',
                            phone: 'No. Telefon',
                            ipgKampus: 'IPGM/IPGK',
                            jawatan: 'Jawatan',
                            gred: 'Gred'
                        };
                        return { isValid: false, message: `Sila lengkapkan maklumat ${fieldNames[field]}.` };
                    }
                }
                
                const icNumber = state.responses.demographics.ic || '';
                if (icNumber.length !== 12) {
                    return { isValid: false, message: `No. MyKad mesti mengandungi tepat 12 digit nombor (semasa: ${icNumber.length} digit).` };
                }

                // Check email uniqueness
                const email = state.responses.demographics.email;
                if (email && state.submittedEmails.has(email.toLowerCase())) {
                    return { isValid: false, message: 'Email ini telah digunakan untuk mengisi borang. Setiap email hanya boleh digunakan sekali sahaja.' };
                }
            } else if (state.currentSection === 1) {
                for (let i = 0; i < personalityQuestions.length; i++) {
                    if (!state.responses.personality[i]) {
                        return { isValid: false, message: `Sila jawab semua soalan dalam Bahagian B. Soalan ${i + 1} belum dijawab.` };
                    }
                }
            } else if (state.currentSection === 2) {
                for (let i = 0; i < wellbeingQuestions.length; i++) {
                    if (!state.responses.wellbeing[i]) {
                        return { isValid: false, message: `Sila jawab semua soalan dalam Bahagian C. Soalan ${i + 1} belum dijawab.` };
                    }
                }
            }
            return { isValid: true };
        }

        function handleNextSection() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                alert(validation.message);
                return;
            }
            state.currentSection++;
            render();
        }

        function handlePrevSection() {
            state.currentSection = Math.max(0, state.currentSection - 1);
            render();
        }

        function calculatePersonalityScores() {
            const { personality } = state.responses;
            
            // Big 5 scoring with proper reverse scoring for BFI-44
            const extraversionItems = [0, 5, 10, 15, 20, 25, 30, 35];
            const extraversionReverse = [5, 15, 25, 35];
            let extraversion = 0;
            extraversionItems.forEach(i => {
                const score = personality[i] || 3;
                extraversion += extraversionReverse.includes(i) ? (6 - score) : score;
            });

            const agreeablenessItems = [1, 6, 11, 16, 21, 26, 31, 36, 41];
            const agreeablenessReverse = [6, 11, 26, 36];
            let agreeableness = 0;
            agreeablenessItems.forEach(i => {
                const score = personality[i] || 3;
                agreeableness += agreeablenessReverse.includes(i) ? (6 - score) : score;
            });

            const conscientiousnessItems = [2, 7, 12, 17, 22, 27, 32, 37, 42];
            const conscientiousnessReverse = [7, 17, 22, 42];
            let conscientiousness = 0;
            conscientiousnessItems.forEach(i => {
                const score = personality[i] || 3;
                conscientiousness += conscientiousnessReverse.includes(i) ? (6 - score) : score;
            });

            const neuroticismItems = [3, 8, 13, 18, 23, 28, 33, 38];
            const neuroticismReverse = [3, 23, 28, 33];
            let neuroticism = 0;
            neuroticismItems.forEach(i => {
                const score = personality[i] || 3;
                neuroticism += neuroticismReverse.includes(i) ? (6 - score) : score;
            });

            const opennessItems = [4, 9, 14, 19, 24, 29, 34, 39, 40, 43];
            const opennessReverse = [9, 24, 34, 39];
            let openness = 0;
            opennessItems.forEach(i => {
                const score = personality[i] || 3;
                openness += opennessReverse.includes(i) ? (6 - score) : score;
            });

            return {
                extraversion: Math.round((extraversion / (8 * 5)) * 100),
                agreeableness: Math.round((agreeableness / (9 * 5)) * 100),
                conscientiousness: Math.round((conscientiousness / (9 * 5)) * 100),
                neuroticism: Math.round((neuroticism / (8 * 5)) * 100),
                openness: Math.round((openness / (10 * 5)) * 100)
            };
        }

        function calculateWellbeingScore() {
            const { wellbeing } = state.responses;
            const totalScore = Object.values(wellbeing).reduce((sum, score) => sum + (score || 1), 0);
            return {
                total: totalScore,
                percentage: Math.round((totalScore / 70) * 100)
            };
        }

        // Google Sheets Integration
        async function sendToGoogleSheets(data) {
            const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbx8zxeOAY-qm0vRcZIIBO1kGbvzZRXTVqaMA6NDe5Pj-a_xO0rJCgHEEHPtqZL3aHUU1A/exec';
            
            try {
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('âœ… Data sent to Google Sheets successfully');
                return true;
            } catch (error) {
                console.error('âŒ Error sending data to Google Sheets:', error);
                return false;
            }
        }

        function showResults() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                alert(validation.message);
                return;
            }
            
            // Add email to submitted list
            const email = state.responses.demographics.email;
            if (email) {
                state.submittedEmails.add(email.toLowerCase());
            }
            
            // Calculate scores
            const personalityScores = calculatePersonalityScores();
            const wellbeingScore = calculateWellbeingScore();
            
            // Prepare data for Google Sheets
            const sheetData = {
                timestamp: new Date().toISOString(),
                nama: state.responses.demographics.name || '',
                mykad: state.responses.demographics.ic || '',
                email: state.responses.demographics.email || '',
                jantina: state.responses.demographics.gender || '',
                bangsa: state.responses.demographics.race || '',
                agama: state.responses.demographics.religion || '',
                telefon: state.responses.demographics.phone || '',
                ipgKampus: state.responses.demographics.ipgKampus || '',
                jawatan: state.responses.demographics.jawatan || '',
                gred: state.responses.demographics.gred || '',
                
                // Personality Scores
                extraversion: personalityScores.extraversion || 0,
                agreeableness: personalityScores.agreeableness || 0,
                conscientiousness: personalityScores.conscientiousness || 0,
                neuroticism: personalityScores.neuroticism || 0,
                openness: personalityScores.openness || 0,
                
                // Individual personality responses (P1-P44)
                ...Object.fromEntries(
                    Array.from({length: 44}, (_, i) => [`p${i+1}`, state.responses.personality[i] || 0])
                ),
                
                // Wellbeing data
                wellbeingTotal: wellbeingScore.total || 0,
                wellbeingPercentage: wellbeingScore.percentage || 0,
                
                // Individual wellbeing responses (W1-W14)
                ...Object.fromEntries(
                    Array.from({length: 14}, (_, i) => [`w${i+1}`, state.responses.wellbeing[i] || 0])
                )
            };
            
            // Send to Google Sheets
            sendToGoogleSheets(sheetData);
            
            // Console log for debugging (formatted as before)
            const formattedData = [
                new Date().toISOString(),
                state.responses.demographics.name || '',
                state.responses.demographics.ic || '',
                state.responses.demographics.email || '',
                state.responses.demographics.gender || '',
                state.responses.demographics.race || '',
                state.responses.demographics.religion || '',
                state.responses.demographics.phone || '',
                state.responses.demographics.ipgKampus || '',
                state.responses.demographics.jawatan || '',
                state.responses.demographics.gred || '',
                personalityScores.extraversion || 0,
                personalityScores.agreeableness || 0,
                personalityScores.conscientiousness || 0,
                personalityScores.neuroticism || 0,
                personalityScores.openness || 0,
                ...Array.from({length: 44}, (_, i) => state.responses.personality[i] || 0),
                wellbeingScore.total || 0,
                wellbeingScore.percentage || 0,
                ...Array.from({length: 14}, (_, i) => state.responses.wellbeing[i] || 0)
            ];
            
            console.log('ðŸ“Š DATA FOR DATABASE:', formattedData);
            console.log('ðŸ‘¤ Demographics:', state.responses.demographics);
            console.log('ðŸ§  Personality Scores:', personalityScores);
            console.log('â¤ï¸ Wellbeing Score:', wellbeingScore);
            console.log('ðŸ“¡ Sent to Google Sheets:', sheetData);
            
            state.showResults = true;
            render();
        }

        function generatePDF() {
            const personalityScores = calculatePersonalityScores();
            const wellbeingScore = calculateWellbeingScore();
            const { demographics } = state.responses;

            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Set font
            doc.setFont("helvetica");
            
            // Title
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("PROFIL KESEJAHTERAAN DAN PERSONALITI WARGA", 105, 20, { align: "center" });
            
            // Institution
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Institut Pendidikan Guru Malaysia", 105, 28, { align: "center" });
            doc.text("Unit Psikologi dan Kaunseling", 105, 35, { align: "center" });
            
            // Add warning notice about one submission per email
            doc.setFontSize(8);
            doc.setFont("helvetica", "italic");
            doc.setTextColor(255, 0, 0); // Red
            doc.text("PENTING: Setiap alamat email hanya dibenarkan satu kali pengisian sahaja", 105, 50, { align: "center" });
            doc.setTextColor(0, 0, 0); // Reset to black
            
            // Demographics Section - Table format
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("MAKLUMAT DIRI", 20, 50);
            
            // Table setup
            const tableStartY = 60;
            const rowHeight = 10;
            const col1X = 20;
            const col2X = 110;
            const tableWidth = 170;
            
            // Table data - including date and new fields
            const tableData = [
                ['Nama:', demographics.name || 'Tidak dinyatakan', 'No. MyKad:', demographics.ic || 'Tidak dinyatakan'],
                ['Email:', demographics.email || 'Tidak dinyatakan', 'Jantina:', demographics.gender || 'Tidak dinyatakan'],
                ['Bangsa:', demographics.race || 'Tidak dinyatakan', 'Agama:', demographics.religion || 'Tidak dinyatakan'],
                ['No. Telefon:', demographics.phone || 'Tidak dinyatakan', 'Jawatan:', demographics.jawatan || 'Tidak dinyatakan'],
                ['Gred:', demographics.gred || 'Tidak dinyatakan', 'Tarikh:', new Date().toLocaleDateString('ms-MY')]
            ];
            
            doc.setFontSize(10);
            
            // Draw table border
            doc.setDrawColor(100, 100, 100);
            doc.setLineWidth(0.5);
            doc.rect(col1X, tableStartY - 5, tableWidth, (tableData.length + 1) * rowHeight);
            
            // Draw table rows
            tableData.forEach((row, index) => {
                const currentY = tableStartY + (index * rowHeight);
                
                // Draw horizontal lines
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.3);
                if (index > 0) {
                    doc.line(col1X, currentY - 5, col1X + tableWidth, currentY - 5);
                }
                
                // Draw vertical line in middle for all rows
                doc.line(col2X, tableStartY - 5, col2X, tableStartY + (tableData.length * rowHeight) - 5);
                
                // Left column - Label
                doc.setFont("helvetica", "bold");
                doc.text(row[0], col1X + 3, currentY);
                
                // Left column - Value
                doc.setFont("helvetica", "normal");
                doc.text(row[1], col1X + 25, currentY);
                
                // Right column - Label
                doc.setFont("helvetica", "bold");
                doc.text(row[2], col2X + 3, currentY);
                
                // Right column - Value
                doc.setFont("helvetica", "normal");
                doc.text(row[3], col2X + 25, currentY);
            });
            
            // IPG Kampus - Full width row
            const ipgY = tableStartY + (tableData.length * rowHeight);
            
            // Draw horizontal line
            doc.setDrawColor(180, 180, 180);
            doc.line(col1X, ipgY - 5, col1X + tableWidth, ipgY - 5);
            
            // IPG Kampus text
            doc.setFont("helvetica", "bold");
            doc.text("IPG Kampus:", col1X + 3, ipgY);
            doc.setFont("helvetica", "normal");
            
            // Handle long IPG Kampus text
            const ipgText = demographics.ipgKampus || 'Tidak dinyatakan';
            doc.text(ipgText, col1X + 25, ipgY);
            
            let yPos = ipgY + 15;
            
            // Side by side layout - LEFT SIDE: Personality
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(37, 99, 235); // Blue color
            doc.text("Personaliti Big 5", 20, yPos);
            
            // RIGHT SIDE: Wellbeing title
            doc.setTextColor(34, 197, 94); // Green color
            doc.text("Kesejahteraan Mental", 115, yPos);
            yPos += 15;
            
            // LEFT SIDE: Personality scores
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0); // Black
            doc.setFont("helvetica", "normal");
            
            const traits = [
                ['Extraversion', personalityScores.extraversion],
                ['Agreeableness', personalityScores.agreeableness],
                ['Conscientiousness', personalityScores.conscientiousness],
                ['Neuroticism', personalityScores.neuroticism],
                ['Openness', personalityScores.openness]
            ];
            
            let leftYPos = yPos;
            traits.forEach(([trait, score], index) => {
                doc.text(`${trait}`, 22, leftYPos);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(37, 99, 235); // Blue
                doc.text(`${score}%`, 75, leftYPos);
                
                // Draw progress bar
                doc.setDrawColor(229, 231, 235);
                doc.setLineWidth(0.5);
                doc.rect(22, leftYPos + 2, 60, 4);
                
                // Fill progress bar
                doc.setFillColor(59, 130, 246); // Blue color
                doc.rect(22, leftYPos + 2, (score / 100) * 60, 4, 'F');
                
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0, 0, 0);
                leftYPos += 15;
            });
            
            // RIGHT SIDE: Wellbeing scores
            let rightYPos = yPos;
            
            // Large wellbeing score
            doc.setFontSize(36);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(34, 197, 94); // Green
            doc.text(`${wellbeingScore.total}/70`, 140, rightYPos + 15, { align: "center" });
            
            doc.setFontSize(20);
            doc.text(`${wellbeingScore.percentage}%`, 140, rightYPos + 30, { align: "center" });
            
            // Wellbeing progress bar
            doc.setDrawColor(229, 231, 235);
            doc.setLineWidth(0.5);
            doc.rect(117, rightYPos + 35, 65, 8);
            
            // Fill wellbeing progress bar
            doc.setFillColor(34, 197, 94); // Green color
            doc.rect(117, rightYPos + 35, (wellbeingScore.percentage / 100) * 65, 8, 'F');
            
            rightYPos += 50;
            
            // Status
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(34, 197, 94);
            doc.text("Status Kesejahteraan:", 117, rightYPos);
            rightYPos += 8;
            
            const status = wellbeingScore.percentage >= 70 ? 'âœ“ Tahap kesejahteraan yang baik' :
                          wellbeingScore.percentage >= 50 ? 'âš  Tahap kesejahteraan sederhana' :
                          '! Mungkin memerlukan perhatian lebih';
            
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0, 0, 0);
            doc.text(status, 117, rightYPos);
            rightYPos += 10;
            
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Skor minimum: 14 | Skor maksimum: 70`, 117, rightYPos);
            doc.text(`Skor anda: ${wellbeingScore.total} (${wellbeingScore.percentage}%)`, 117, rightYPos + 6);
            
            // Personality Interpretation (bottom section)
            let interpretationYPos = leftYPos + 10;
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(37, 99, 235);
            doc.text("Interpretasi Personaliti:", 20, interpretationYPos);
            interpretationYPos += 10;
            
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(0, 0, 0);
            
            traits.forEach(([trait, score]) => {
                const level = score >= 70 ? 'Tinggi' : score >= 30 ? 'Sederhana' : 'Rendah';
                doc.setTextColor(37, 99, 235);
                doc.setFont("helvetica", "bold");
                doc.text(`${trait}:`, 22, interpretationYPos);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0, 0, 0);
                doc.text(`${level}`, 55, interpretationYPos);
                interpretationYPos += 8;
            });
            
            // Footer
            doc.setFontSize(8);
            doc.setFont("helvetica", "italic");
            doc.setTextColor(100, 100, 100);
            doc.text("Laporan ini dijana secara automatik oleh Sistem Profil Kesejahteraan dan Personaliti Warga IPG", 105, 280, { align: "center" });
            
            // PAGE 2 - INTERPRETATION (LANDSCAPE)
            doc.addPage('a4', 'landscape');
            
            // Page 2 Title
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(0, 0, 0);
            doc.text("PENTAFSIRAN SKOR", 148, 20, { align: "center" }); // Centered for landscape
            
            // Personality Interpretation Table
            let currentY = 35;
            
            // Table headers - wider layout for landscape
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            
            // Draw header background for personality section
            doc.setFillColor(100, 149, 237); // Blue
            doc.rect(20, currentY - 5, 256, 10, 'F'); // Wider for landscape
            doc.setTextColor(255, 255, 255);
            doc.text("KONSTRUK PERSONALITI", 30, currentY);
            doc.text("SKOR", 180, currentY, { align: "center" });
            doc.text("TAHAP", 230, currentY, { align: "center" });
            
            currentY += 18;
            
            // Extraversion
            doc.setFillColor(135, 206, 235); // Light blue
            doc.rect(20, currentY - 5, 256, 18, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "bold");
            doc.text("EXTRAVERSION (Ekstraverti)", 30, currentY);
            doc.setFont("helvetica", "normal");
            doc.text("Individu yang mempunyai kecenderungan untuk bersosialisasi dan berhubung dengan orang lain.", 30, currentY + 6);
            doc.setFont("helvetica", "bold");
            doc.text(personalityScores.extraversion.toString(), 180, currentY + 6, { align: "center" });
            doc.text(personalityScores.extraversion >= 70 ? 'TINGGI' : personalityScores.extraversion >= 30 ? 'SEDERHANA' : 'RENDAH', 230, currentY + 6, { align: "center" });
            
            currentY += 28;
            
            // Agreeableness
            doc.setFillColor(255, 255, 224); // Light yellow
            doc.rect(20, currentY - 5, 256, 18, 'F');
            doc.setFont("helvetica", "bold");
            doc.text("AGREEABLENESS (Kesetujuan)", 30, currentY);
            doc.setFont("helvetica", "normal");
            doc.text("Individu yang menunjukkan ciri-ciri boleh dipercayai, bertoleransi, baik, dan bersikap kasih sayang.", 30, currentY + 6);
            doc.setFont("helvetica", "bold");
            doc.text(personalityScores.agreeableness.toString(), 180, currentY + 6, { align: "center" });
            doc.text(personalityScores.agreeableness >= 70 ? 'TINGGI' : personalityScores.agreeableness >= 30 ? 'SEDERHANA' : 'RENDAH', 230, currentY + 6, { align: "center" });
            
            currentY += 28;
            
            // Conscientiousness
            doc.setFillColor(255, 182, 193); // Light pink
            doc.rect(20, currentY - 5, 256, 18, 'F');
            doc.setFont("helvetica", "bold");
            doc.text("CONSCIENTIOUSNESS (Ketelitian)", 30, currentY);
            doc.setFont("helvetica", "normal");
            doc.text("Individu yang mempunyai kecenderungan untuk berfokus teliti, bersungguh, bermatlamat dan", 30, currentY + 6);
            doc.text("berpegang teguh pada cita tinggi.", 30, currentY + 12);
            doc.setFont("helvetica", "bold");
            doc.text(personalityScores.conscientiousness.toString(), 180, currentY + 6, { align: "center" });
            doc.text(personalityScores.conscientiousness >= 70 ? 'TINGGI' : personalityScores.conscientiousness >= 30 ? 'SEDERHANA' : 'RENDAH', 230, currentY + 6, { align: "center" });
            
            currentY += 28;
            
            // Neuroticism
            doc.setFillColor(255, 160, 160); // Light red
            doc.rect(20, currentY - 5, 256, 18, 'F');
            doc.setFont("helvetica", "bold");
            doc.text("NEUROTICISM (Neurotisisme)", 30, currentY);
            doc.setFont("helvetica", "normal");
            doc.text("Individu yang mudah terjerumus dengan kesedihan, dan ketidakstabilan emosi.", 30, currentY + 6);
            doc.setFont("helvetica", "bold");
            doc.text(personalityScores.neuroticism.toString(), 180, currentY + 6, { align: "center" });
            doc.text(personalityScores.neuroticism >= 70 ? 'TINGGI' : personalityScores.neuroticism >= 30 ? 'SEDERHANA' : 'RENDAH', 230, currentY + 6, { align: "center" });
            
            currentY += 28;
            
            // Openness
            doc.setFillColor(144, 238, 144); // Light green
            doc.rect(20, currentY - 5, 256, 18, 'F');
            doc.setFont("helvetica", "bold");
            doc.text("OPENNESS (Keterbukaan)", 30, currentY);
            doc.setFont("helvetica", "normal");
            doc.text("Individu yang mempunyai kemahiran berinteraksi dengan budaya, orang, idea dan pengalaman", 30, currentY + 6);
            doc.text("yang pelbagai.", 30, currentY + 12);
            doc.setFont("helvetica", "bold");
            doc.text(personalityScores.openness.toString(), 180, currentY + 6, { align: "center" });
            doc.text(personalityScores.openness >= 70 ? 'TINGGI' : personalityScores.openness >= 30 ? 'SEDERHANA' : 'RENDAH', 230, currentY + 6, { align: "center" });
            
            currentY += 35;
            
            // Wellbeing Section
            doc.setFillColor(34, 197, 94); // Green
            doc.rect(20, currentY - 5, 256, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.text("SKALA KESEJAHTERAAN PSIKOLOGI", 30, currentY);
            
            currentY += 18;
            
            // Determine wellbeing color based on level
            let wellbeingColor, wellbeingLevel;
            if (wellbeingScore.percentage >= 70) {
                wellbeingColor = [144, 238, 144]; // Light green
                wellbeingLevel = 'TINGGI';
            } else if (wellbeingScore.percentage >= 50) {
                wellbeingColor = [255, 255, 224]; // Light yellow  
                wellbeingLevel = 'SEDERHANA';
            } else {
                wellbeingColor = [255, 182, 193]; // Light red
                wellbeingLevel = 'RENDAH';
            }
            
            doc.setFillColor(wellbeingColor[0], wellbeingColor[1], wellbeingColor[2]);
            doc.rect(20, currentY - 5, 256, 15, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");
            doc.text("Skala yang mengukur kesejahteraan mental dan emosi individu dalam kehidupan seharian.", 30, currentY + 5);
            doc.setFont("helvetica", "bold");
            doc.text(wellbeingScore.total.toString() + '/70', 180, currentY + 5, { align: "center" });
            doc.text(wellbeingLevel, 230, currentY + 5, { align: "center" });
            
            // Page 2 Footer
            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100, 100, 100);
            doc.text("2025 Â© Unit Psikologi & Kaunseling, IPGM", 148, 200, { align: "center" });
            
            // PAGE 3 - GUIDELINES AND RECOMMENDATIONS (LANDSCAPE)
            doc.addPage('a4', 'landscape');
            
            // Page 3 Title
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(0, 0, 0);
            doc.text("PANDUAN INTERPRETASI & CADANGAN", 148, 20, { align: "center" });
            
            currentY = 35;
            
            // Two-column layout for landscape
            const leftColumnX = 25;
            const rightColumnX = 155;
            
            // Left Column - Interpretation Guidelines
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(0, 0, 0);
            doc.text("PANDUAN INTERPRETASI:", leftColumnX, currentY);
            
            currentY += 15;
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            
            // Personality interpretation guidelines
            doc.setFont("helvetica", "bold");
            doc.text("PERSONALITI:", leftColumnX, currentY);
            doc.setFont("helvetica", "normal");
            currentY += 8;
            doc.text("â€¢ TINGGI (70-100): Ciri personaliti yang sangat menonjol", leftColumnX + 5, currentY);
            currentY += 6;
            doc.text("â€¢ SEDERHANA (30-69): Ciri personaliti yang seimbang", leftColumnX + 5, currentY);
            currentY += 6;
            doc.text("â€¢ RENDAH (0-29): Ciri personaliti yang kurang menonjol", leftColumnX + 5, currentY);
            
            currentY += 15;
            
            // Wellbeing interpretation guidelines
            doc.setFont("helvetica", "bold");
            doc.text("KESEJAHTERAAN PSIKOLOGI:", leftColumnX, currentY);
            doc.setFont("helvetica", "normal");
            currentY += 8;
            doc.text("â€¢ TINGGI (70-100%): Tahap kesejahteraan yang sangat baik", leftColumnX + 5, currentY);
            currentY += 6;
            doc.text("â€¢ SEDERHANA (50-69%): Tahap kesejahteraan yang sederhana", leftColumnX + 5, currentY);
            currentY += 6;
            doc.text("â€¢ RENDAH (0-49%): Mungkin memerlukan perhatian dan sokongan", leftColumnX + 5, currentY);
            
            // Right Column - Personality Descriptions
            let rightCurrentY = 50;
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(37, 99, 235); // Blue
            doc.text("MAKNA SETIAP KONSTRUK PERSONALITI:", rightColumnX, rightCurrentY);
            
            rightCurrentY += 15;
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            
            // Extraversion detailed description
            doc.setFont("helvetica", "bold");
            doc.text("EXTRAVERSION (Ekstraverti):", rightColumnX, rightCurrentY);
            doc.setFont("helvetica", "normal");
            rightCurrentY += 6;
            doc.text("- Suka berinteraksi dan berkomunikasi dengan orang lain", rightColumnX + 5, rightCurrentY);
            rightCurrentY += 5;
            doc.text("- Bertenaga dalam situasi sosial", rightColumnX + 5, rightCurrentY);
            rightCurrentY += 5;
            doc.text("- Berani mengambil risiko dan mencari pengalaman baru", rightColumnX + 5, rightCurrentY);
            
            rightCurrentY += 10;
            
            // Agreeableness detailed description
            doc.setFont("helvetica", "bold");
            doc.text("AGREEABLENESS (Kesetujuan):", rightColumnX, rightCurrentY);
            doc.setFont("helvetica", "normal");
            rightCurrentY += 6;
            doc.text("- Mudah bekerjasama dan membantu orang lain", rightColumnX + 5, rightCurrentY);
            rightCurrentY += 5;
            doc.text("- Bersikap penyayang dan penuh empati", rightColumnX + 5, rightCurrentY);
            rightCurrentY += 5;
            doc.text("- Mudah mempercayai dan memaafkan orang lain", rightColumnX + 5, rightCurrentY);
            
            rightCurrentY += 10;
            
            // Conscientiousness detailed description
            doc.setFont("helvetica", "bold");
            doc.text("CONSCIENTIOUSNESS (Ketelitian):", rightColumnX, rightCurrentY);
            doc.setFont("helvetica", "normal");
            rightCurrentY += 6;
            doc.text("- Teratur, berdisiplin dan bertanggungjawab", rightColumnX + 5, rightCurrentY);
            rightCurrentY += 5;
            doc.text("- Bekerja dengan teliti dan berfokus pada matlamat", rightColumnX + 5, rightCurrentY);
            rightCurrentY += 5;
            doc.text("- Boleh dipercayai dan konsisten dalam tindakan", rightColumnX + 5, rightCurrentY);
            
            rightCurrentY += 10;
            
            // Neuroticism detailed description
            doc.setFont("helvetica", "bold");
            doc.text("NEUROTICISM (Neurotisisme):", rightColumnX, rightCurrentY);
            doc.setFont("helvetica", "normal");
            rightCurrentY += 6;
            doc.text("- Kecenderungan mengalami emosi negatif", rightColumnX + 5, rightCurrentY);
            rightCurrentY += 5;
            doc.text("- Mudah merasa cemas, tertekan atau marah", rightColumnX + 5, rightCurrentY);
            rightCurrentY += 5;
            doc.text("- Kurang stabil dari segi emosi dalam situasi tekanan", rightColumnX + 5, rightCurrentY);
            
            rightCurrentY += 10;
            
            // Openness detailed description
            doc.setFont("helvetica", "bold");
            doc.text("OPENNESS (Keterbukaan):", rightColumnX, rightCurrentY);
            doc.setFont("helvetica", "normal");
            rightCurrentY += 6;
            doc.text("- Kreatif, imaginatif dan suka mencuba perkara baru", rightColumnX + 5, rightCurrentY);
            rightCurrentY += 5;
            doc.text("- Terbuka kepada idea dan pengalaman baru", rightColumnX + 5, rightCurrentY);
            rightCurrentY += 5;
            doc.text("- Menghargai seni, budaya dan intelektual", rightColumnX + 5, rightCurrentY);
            
            // Bottom section - recommendations (full width)
            currentY = Math.max(currentY + 25, rightCurrentY + 15);
            
            // Recommendation section
            doc.setFont("helvetica", "normal");
            doc.setTextColor(255, 0, 0); // Red
            doc.text("Sila dapatkan perundingan Kaunselor Pendidikan terdekat bagi sebarang urusan (yang berkaitan sahaja / jika perlu)", leftColumnX, currentY);
            
            currentY += 15;
            
            // Counselor info section
            doc.setFont("helvetica", "bold");
            doc.setTextColor(0, 0, 0);
            doc.text("TANDATANGAN KAUNSELOR:", leftColumnX, currentY);
            
            currentY += 15;
            doc.setFont("helvetica", "normal");
            doc.text("NAMA KAUNSELOR: ......................................................................", leftColumnX, currentY);
            
            currentY += 10;
            doc.text("COP RASMI: ......................................................................", leftColumnX, currentY);
            
            // Page 3 Footer
            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100, 100, 100);
            doc.text("2025 Â© Unit Psikologi & Kaunseling, IPGM", 148, 200, { align: "center" });            currentY += 15;
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            
            // Extraversion detailed description
            doc.setFont("helvetica", "bold");
            doc.text("EXTRAVERSION (Ekstraverti):", 25, currentY);
            doc.setFont("helvetica", "normal");
            currentY += 6;
            doc.text("- Suka berinteraksi dan berkomunikasi dengan orang lain", 30, currentY);
            currentY += 5;
            doc.text("- Bertenaga dalam situasi sosial", 30, currentY);
            currentY += 5;
            doc.text("- Berani mengambil risiko dan mencari pengalaman baru", 30, currentY);
            
            currentY += 10;
            
            // Agreeableness detailed description
            doc.setFont("helvetica", "bold");
            doc.text("AGREEABLENESS (Kesetujuan):", 25, currentY);
            doc.setFont("helvetica", "normal");
            currentY += 6;
            doc.text("- Mudah bekerjasama dan membantu orang lain", 30, currentY);
            currentY += 5;
            doc.text("- Bersikap penyayang dan penuh empati", 30, currentY);
            currentY += 5;
            doc.text("- Mudah mempercayai dan memaafkan orang lain", 30, currentY);
            
            currentY += 10;
            
            // Conscientiousness detailed description
            doc.setFont("helvetica", "bold");
            doc.text("CONSCIENTIOUSNESS (Ketelitian):", 25, currentY);
            doc.setFont("helvetica", "normal");
            currentY += 6;
            doc.text("- Teratur, berdisiplin dan bertanggungjawab", 30, currentY);
            currentY += 5;
            doc.text("- Bekerja dengan teliti dan berfokus pada matlamat", 30, currentY);
            currentY += 5;
            doc.text("- Boleh dipercayai dan konsisten dalam tindakan", 30, currentY);
            
            currentY += 10;
            
            // Neuroticism detailed description
            doc.setFont("helvetica", "bold");
            doc.text("NEUROTICISM (Neurotisisme):", 25, currentY);
            doc.setFont("helvetica", "normal");
            currentY += 6;
            doc.text("- Kecenderungan mengalami emosi negatif", 30, currentY);
            currentY += 5;
            doc.text("- Mudah merasa cemas, tertekan atau marah", 30, currentY);
            currentY += 5;
            doc.text("- Kurang stabil dari segi emosi dalam situasi tekanan", 30, currentY);
            
            currentY += 10;
            
            // Openness detailed description
            doc.setFont("helvetica", "bold");
            doc.text("OPENNESS (Keterbukaan):", 25, currentY);
            doc.setFont("helvetica", "normal");
            currentY += 6;
            doc.text("- Kreatif, imaginatif dan suka mencuba perkara baru", 30, currentY);
            currentY += 5;
            doc.text("- Terbuka kepada idea dan pengalaman baru", 30, currentY);
            currentY += 5;
            doc.text("- Menghargai seni, budaya dan intelektual", 30, currentY);
            
            currentY += 20;
            
            // Recommendation section
            doc.setFont("helvetica", "normal");
            doc.setTextColor(255, 0, 0); // Red
            doc.text("Sila dapatkan perundingan Kaunselor Pendidikan terdekat bagi sebarang urusan", 25, currentY);
            doc.text("(yang berkaitan sahaja / jika perlu)", 25, currentY + 7);
            
            currentY += 25;
            
            // Counselor info section
            doc.setFont("helvetica", "bold");
            doc.setTextColor(0, 0, 0);
            doc.text("TANDATANGAN KAUNSELOR:", 25, currentY);
            
            currentY += 20;
            doc.setFont("helvetica", "normal");
            doc.text("NAMA KAUNSELOR: ......................................................................", 25, currentY);
            
            currentY += 15;
            doc.text("COP RASMI: ......................................................................", 25, currentY);
            
            // Page 3 Footer
            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100, 100, 100);
            doc.text("2025 Â© Unit Psikologi & Kaunseling, IPGM", 105, 280, { align: "center" });
            
            // Save the PDF
            const fileName = `Keputusan_PKPW_${demographics.name ? demographics.name.replace(/\s+/g, '_') : 'IPG'}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        // Render functions
        function renderHeader() {
            return `
                <div class="mb-8 fade-in">
                    <h1 class="text-3xl font-bold text-center text-blue-800 mb-2">
                        Profil Kesejahteraan dan Personaliti Warga
                    </h1>
                    <h2 class="text-xl font-semibold text-center text-blue-700 mb-4">
                        Institut Pendidikan Guru Malaysia
                    </h2>
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h3 class="font-bold text-blue-800 mb-2">Pengenalan:</h3>
                        <p class="text-sm text-gray-700 mb-2">
                            Profil Kesejahteraan dan Personaliti Warga terdiri dari tiga bahagian iaitu:
                        </p>
                        <ul class="text-sm text-gray-700 space-y-1 ml-4">
                            <li>â€¢ Bahagian A: Maklumat Diri</li>
                            <li>â€¢ Bahagian B: Ujian Personaliti (44 ITEM)</li>
                            <li>â€¢ Bahagian C: Skala Kesejahteraan Psikologi (14 ITEM)</li>
                        </ul>
                        <p class="text-sm text-gray-700 mt-2">
                            <strong>Komitmen Masa:</strong> Masa yang diambil untuk menjawab inventori ini adalah antara 20 minit.
                        </p>
                    </div>

                    <div class="flex justify-center mb-8">
                        <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-6">
                                ${['Maklumat Diri', 'Ujian Personaliti', 'Kesejahteraan Psikologi'].map((title, index) => `
                                    <div class="flex flex-col items-center px-4 sm:px-6 py-4 rounded-lg transition-all duration-200 ${
                                        state.currentSection === index
                                            ? 'bg-blue-600 text-white shadow-lg'
                                            : state.currentSection > index
                                            ? 'bg-green-500 text-white'
                                            : 'bg-gray-100 text-gray-600'
                                    }">
                                        <div class="text-2xl mb-2">
                                            ${index === 0 ? 'ðŸ‘¤' : index === 1 ? 'ðŸ§ ' : 'â¤ï¸'}
                                        </div>
                                        <div class="text-center">
                                            <div class="text-sm font-semibold">Bahagian ${String.fromCharCode(65 + index)}</div>
                                            <div class="text-xs font-medium">${title}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDemographics() {
            return `
                <div class="space-y-6 fade-in">
                    <h2 class="text-2xl font-bold text-blue-800">Bahagian A: Maklumat Diri</h2>
                    <p class="text-gray-600 text-sm">Sila isi maklumat peribadi anda dengan lengkap dan tepat.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${demographicsQuestions.map(q => `
                            <div class="space-y-2 ${q.id === 'ipgKampus' ? 'md:col-span-2' : ''}">
                                <label class="block text-sm font-medium text-gray-700">
                                    ${q.label} ${q.required ? '<span class="text-red-500">*</span>' : ''}
                                    ${q.id === 'ic' ? `
                                        <div class="text-xs text-gray-500 mt-1">
                                            <span id="ic-counter" class="${state.responses.demographics.ic && state.responses.demographics.ic.length === 12 ? 'text-green-600' : 'text-red-500'}">
                                                ${state.responses.demographics.ic ? `(${state.responses.demographics.ic.length}/12)` : '(0/12)'}
                                            </span>
                                        </div>
                                    ` : ''}
                                </label>
                                ${q.type === 'select' ? `
                                    <select 
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        onchange="handleDemographicChange('${q.id}', this.value)"
                                    >
                                        <option value="">${q.id === 'gender' ? 'Pilih jantina' : q.id === 'race' ? 'Pilih bangsa' : q.id === 'religion' ? 'Pilih agama' : q.id === 'ipgKampus' ? 'Pilih IPGM/IPGK' : q.id === 'jawatan' ? 'Pilih jawatan' : q.id === 'gred' ? 'Pilih gred' : 'Sila pilih...'}</option>
                                        ${q.options.map(option => `
                                            <option value="${option}" ${state.responses.demographics[q.id] === option ? 'selected' : ''}>${option}</option>
                                        `).join('')}
                                    </select>
                                ` : `
                                    <input 
                                        type="${q.type}"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        value="${state.responses.demographics[q.id] || ''}"
                                        placeholder="${q.id === 'ic' ? 'Contoh: 901201081234' : q.id === 'name' ? 'Sila isi nama penuh anda' : q.id === 'email' ? 'Contoh: nama@ipgm.edu.my' : q.id === 'phone' ? 'Contoh: 0123456789' : 'Sila isi...'}"
                                        maxlength="${q.maxLength || ''}"
                                        oninput="handleDemographicChange('${q.id}', this.value)"
                                    />
                                `}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderPersonality() {
            return `
                <div class="space-y-6 fade-in">
                    <h2 class="text-2xl font-bold text-blue-800">Bahagian B: Ujian Personaliti (44 Item)</h2>
                    <p class="text-gray-600">Nyatakan sejauh mana anda bersetuju dengan setiap kenyataan berikut:</p>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 text-xs text-gray-700">
                            <span class="text-center">1 = Sangat Tidak Setuju</span>
                            <span class="text-center">2 = Tidak Setuju</span>
                            <span class="text-center">3 = Neutral</span>
                            <span class="text-center">4 = Setuju</span>
                            <span class="text-center">5 = Sangat Setuju</span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${personalityQuestions.map((question, index) => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <p class="text-sm text-gray-800 mb-3 leading-relaxed">${index + 1}. ${question}</p>
                                <div class="flex justify-center space-x-3">
                                    ${[1, 2, 3, 4, 5].map(value => `
                                        <label class="cursor-pointer">
                                            <input
                                                type="radio"
                                                name="personality-${index}"
                                                value="${value}"
                                                ${state.responses.personality[index] === value ? 'checked' : ''}
                                                onchange="handlePersonalityChange(${index}, ${value})"
                                                class="sr-only"
                                            />
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 ${
                                                state.responses.personality[index] === value 
                                                    ? 'bg-blue-500 text-white shadow-lg transform scale-110' 
                                                    : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                                            }">
                                                ${value}
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderWellbeing() {
            return `
                <div class="space-y-6 fade-in">
                    <h2 class="text-2xl font-bold text-blue-800">Bahagian C: Kesejahteraan Psikologi (14 Item)</h2>
                    <p class="text-gray-600">Fikirkan pengalaman anda dalam <strong>2 minggu yang lalu</strong>. Nyatakan sejauh mana setiap kenyataan menggambarkan pengalaman anda:</p>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 text-xs text-gray-700">
                            <span class="text-center">1 = Tiada Masa</span>
                            <span class="text-center">2 = Jarang</span>
                            <span class="text-center">3 = Sesetengah Masa</span>
                            <span class="text-center">4 = Kerap</span>
                            <span class="text-center">5 = Sepanjang Masa</span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${wellbeingQuestions.map((question, index) => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <p class="text-sm text-gray-800 mb-3 leading-relaxed">${index + 1}. ${question}</p>
                                <div class="flex justify-center space-x-3">
                                    ${[1, 2, 3, 4, 5].map(value => `
                                        <label class="cursor-pointer">
                                            <input
                                                type="radio"
                                                name="wellbeing-${index}"
                                                value="${value}"
                                                ${state.responses.wellbeing[index] === value ? 'checked' : ''}
                                                onchange="handleWellbeingChange(${index}, ${value})"
                                                class="sr-only"
                                            />
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 ${
                                                state.responses.wellbeing[index] === value 
                                                    ? 'bg-green-500 text-white shadow-lg transform scale-110' 
                                                    : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                                            }">
                                                ${value}
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderResults() {
            const personalityScores = calculatePersonalityScores();
            const wellbeingScore = calculateWellbeingScore();

            return `
                <div class="space-y-8 fade-in">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-blue-800 mb-2">Keputusan Anda</h2>
                        <p class="text-gray-600">Profil Kesejahteraan dan Personaliti</p>
                        <p class="text-sm text-gray-500 mt-1">Tarikh: ${new Date().toLocaleDateString('ms-MY')}</p>
                    </div>

                    <!-- Demographics Table -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="bg-blue-600 text-white px-6 py-3">
                            <h3 class="text-lg font-bold">Maklumat Diri</h3>
                        </div>
                        <div class="p-6">
                            <table class="w-full table-auto">
                                <tbody>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50 w-1/3">Nama Penuh</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.name || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">No. MyKad</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.ic || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">Email</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.email || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">Jantina</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.gender || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">Bangsa</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.race || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">Agama</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.religion || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">No. Telefon</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.phone || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">IPG Kampus</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.ipgKampus || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">Jawatan</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.jawatan || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">Gred</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.gred || 'Tidak dinyatakan'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- Big 5 Results -->
                        <div class="bg-blue-50 p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-bold text-blue-800 mb-6 text-center">Personaliti Big 5</h3>
                            <div class="space-y-4">
                                ${Object.entries(personalityScores).map(([trait, score]) => `
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium capitalize text-gray-700">${trait}</span>
                                            <span class="text-sm font-bold text-blue-600">${score}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-3">
                                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-1000 progress-bar" style="width: ${score}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="mt-6 p-4 bg-blue-100 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">Interpretasi Personaliti:</h4>
                                <div class="text-sm text-blue-700 space-y-1">
                                    ${Object.entries(personalityScores).map(([trait, score]) => `
                                        <div><strong>${trait}:</strong> ${score >= 70 ? 'Tinggi' : score >= 30 ? 'Sederhana' : 'Rendah'}</div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Mental Wellbeing -->
                        <div class="p-6 rounded-lg shadow-sm ${
                            wellbeingScore.percentage >= 70 ? 'bg-green-50' :
                            wellbeingScore.percentage >= 50 ? 'bg-yellow-50' :
                            'bg-red-50'
                        }">
                            <h3 class="text-xl font-bold mb-4 ${
                                wellbeingScore.percentage >= 70 ? 'text-green-800' :
                                wellbeingScore.percentage >= 50 ? 'text-yellow-800' :
                                'text-red-800'
                            }">Kesejahteraan Mental</h3>
                            <div class="text-center mb-6">
                                <div class="text-5xl font-bold mb-2 ${
                                    wellbeingScore.percentage >= 70 ? 'text-green-600' :
                                    wellbeingScore.percentage >= 50 ? 'text-yellow-600' :
                                    'text-red-600'
                                }">${wellbeingScore.total}/70</div>
                                <div class="text-2xl text-gray-600 mb-4">${wellbeingScore.percentage}%</div>
                                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                                    <div class="h-4 rounded-full transition-all duration-1000 progress-bar ${
                                        wellbeingScore.percentage >= 70 ? 'bg-gradient-to-r from-green-500 to-green-600' :
                                        wellbeingScore.percentage >= 50 ? 'bg-gradient-to-r from-yellow-500 to-yellow-600' :
                                        'bg-gradient-to-r from-red-500 to-red-600'
                                    }" style="width: ${wellbeingScore.percentage}%"></div>
                                </div>
                            </div>
                            
                            <div class="p-4 rounded-lg ${
                                wellbeingScore.percentage >= 70 ? 'bg-green-100' :
                                wellbeingScore.percentage >= 50 ? 'bg-yellow-100' :
                                'bg-red-100'
                            }">
                                <h4 class="font-semibold mb-2 ${
                                    wellbeingScore.percentage >= 70 ? 'text-green-800' :
                                    wellbeingScore.percentage >= 50 ? 'text-yellow-800' :
                                    'text-red-800'
                                }">Status Kesejahteraan:</h4>
                                <p class="text-sm font-medium ${
                                    wellbeingScore.percentage >= 70 ? 'text-green-700' :
                                    wellbeingScore.percentage >= 50 ? 'text-yellow-700' :
                                    'text-red-700'
                                }">
                                    ${wellbeingScore.percentage >= 70 ? 'âœ… Tahap kesejahteraan yang baik' :
                                      wellbeingScore.percentage >= 50 ? 'âš ï¸ Tahap kesejahteraan sederhana' :
                                      'â— Anda dinasihatkan untuk berjumpa kaunselor pendidikan di IPG anda'}
                                </p>
                                <div class="mt-3 text-xs ${
                                    wellbeingScore.percentage >= 70 ? 'text-green-600' :
                                    wellbeingScore.percentage >= 50 ? 'text-yellow-600' :
                                    'text-red-600'
                                }">
                                    <div>Skor minimum: 14 | Skor maksimum: 70</div>
                                    <div>Skor anda: ${wellbeingScore.total} (${wellbeingScore.percentage}%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 no-print">
                        <button
                            onclick="generatePDF()"
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center space-x-2 shadow-md"
                        >
                            <span>ðŸ“¥</span>
                            <span>Muat Turun Laporan</span>
                        </button>
                        <button
                            onclick="generatePDF()"
                            class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition flex items-center justify-center space-x-2 shadow-md"
                        >
                            <span>ðŸ–¨ï¸</span>
                            <span>Cetak</span>
                        </button>
                        <button
                            onclick="location.reload()"
                            class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition flex items-center justify-center space-x-2 shadow-md"
                        >
                            <span>ðŸ”„</span>
                            <span>Mulakan Semula</span>
                        </button>
                    </div>

                    <!-- Print-only content -->
                    <div class="print-only mt-8">
                        <div class="text-center border-t-2 border-gray-300 pt-4">
                            <p class="text-sm text-gray-600">Institut Pendidikan Guru Malaysia</p>
                            <p class="text-xs text-gray-500">Profil Kesejahteraan dan Personaliti Warga</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFooter() {
            return `
                <div class="mt-12 pt-6 border-t border-gray-200">
                    <p class="text-center text-sm text-gray-500">
                        2025 Â© Unit Psikologi & Kaunseling, IPGM
                    </p>
                </div>
            `;
        }

        function renderNavigation() {
            if (state.showResults) return '';
            
            return `
                <div class="flex flex-col sm:flex-row justify-between items-center mt-8 space-y-4 sm:space-y-0">
                    <button
                        onclick="handlePrevSection()"
                        ${state.currentSection === 0 ? 'disabled' : ''}
                        class="flex items-center space-x-2 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-md w-full sm:w-auto justify-center"
                    >
                        <span>â†</span>
                        <span>Sebelumnya</span>
                    </button>

                    <div class="text-sm text-gray-500 text-center">
                        Bahagian ${state.currentSection + 1} daripada 3
                    </div>

                    ${state.currentSection < 2 ? `
                        <button
                            onclick="handleNextSection()"
                            class="flex items-center space-x-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md w-full sm:w-auto justify-center"
                        >
                            <span>Seterusnya</span>
                            <span>â†’</span>
                        </button>
                    ` : `
                        <button
                            onclick="showResults()"
                            class="flex items-center space-x-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow-md w-full sm:w-auto justify-center"
                        >
                            <span>Lihat Keputusan</span>
                            <span>ðŸŽ¯</span>
                        </button>
                    `}
                </div>
            `;
        }

        function render() {
            let content = '';
            
            if (state.showResults) {
                content = renderResults();
            } else {
                content = renderHeader();
                
                switch (state.currentSection) {
                    case 0:
                        content += renderDemographics();
                        break;
                    case 1:
                        content += renderPersonality();
                        break;
                    case 2:
                        content += renderWellbeing();
                        break;
                }
                
                content += renderNavigation();
            }
            
            // Add footer to every page
            content += renderFooter();
            
            document.getElementById('app').innerHTML = content;
            
            // Scroll to top smoothly
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            render();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (state.showResults) return;
                
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'ArrowLeft':
                            e.preventDefault();
                            if (state.currentSection > 0) handlePrevSection();
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            if (state.currentSection < 2) {
                                handleNextSection();
                            } else {
                                showResults();
                            }
                            break;
                    }
                }
            });
        });
    </script>
</body>
</html>
