import React, { useState, useEffect, useMemo } from 'react';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell 
} from 'recharts';
import { 
  LayoutDashboard, Users, FileText, Settings, LogOut, 
  Lock, Search, Download, BrainCircuit, Calendar, 
  ChevronRight, Save, Image as ImageIcon, Trash2, 
  AlertCircle, CheckCircle2, Sparkles, UserCircle,
  ExternalLink
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from 'firebase/firestore';

// --- KONFIGURASI & TETAPAN TETAP ---
const CAMPUS_NAMES = [
  "IPGK Bahasa Melayu", "IPGK Bahasa Antarabangsa", "IPGK Ilmu Khas", "IPGK Perempuan Melayu",
  "IPGK Pendidikan Islam", "IPGK Pendidikan Teknik", "IPGK Kampus Gaya", "IPGK Kampus Kent",
  "IPGK Kampus Tawau", "IPGK Kampus Sarawak", "IPGK Kampus Batu Lintang", "IPGK Kampus Rajang",
  "ELTC", "IPGK Tun Hussein Onn", "IPGK Kampus Tun Abdul Razak", "IPGK Kampus Temenggong Ibrahim",
  "IPGK Kampus Tuanku Bainun", "IPGK Kampus Sultan Mizan", "IPGK Kampus Dato' Razali Ismail",
  "IPGK Kampus Darulaman", "IPGK Kampus Ipoh", "IPGK Kampus Perlis", "IPGK Kampus Pulau Pinang",
  "IPGK Kampus Sultan Abdul Halim", "IPGK Kampus Tengku Ampuan Afzan", "IPGK Kampus Raja Melewar",
  "IPGK Kampus Kota Bharu", "IPGK Kampus Keningau"
];

const CASE_STATS = [
  { name: 'Keluarga', count: 45 }, { name: 'Akademik', count: 72 },
  { name: 'Kerjaya', count: 30 }, { name: 'Kesihatan Mental', count: 55 },
  { name: 'Disiplin', count: 18 }
];

const POSTERS = [
  { id: '1', title: 'Mengurus Stres Peperiksaan', image: 'https://images.unsplash.com/photo-1516534775068-ba3e7458af70?auto=format&fit=crop&q=80&w=800' },
  { id: '2', title: 'Kepentingan Tidur Cukup', image: 'https://images.unsplash.com/photo-1541781774459-bb2af2f05b55?auto=format&fit=crop&q=80&w=800' },
  { id: '3', title: 'Buli Siber: Apa Tindakan Anda?', image: 'https://images.unsplash.com/photo-1550751827-4bd374c3f58b?auto=format&fit=crop&q=80&w=800' }
];

// Pautan luaran untuk ujian spesifik
const TEST_EXTERNAL_LINKS = {
  'PKPP': 'https://upskipgm.com/PKPP',
  'PKPW': 'https://upskipg.com/PKPW'
};

// --- TETAPAN FIREBASE ---
const firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : { apiKey: "fake-key", authDomain: "fake-domain" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'upskipgm-portal-v1';

// --- PERKHIDMATAN AI ---
const callGemini = async (prompt, systemInstruction = "") => {
  const apiKey = ""; // Diuruskan oleh persekitaran
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
  
  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    systemInstruction: { parts: [{ text: systemInstruction }] }
  };

  for (let i = 0; i < 5; i++) {
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error('Ralat API');
      const result = await response.json();
      return result.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, tiada respon dari AI.";
    } catch (e) {
      await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
    }
  }
  return "Gagal menghubungi AI setelah beberapa percubaan.";
};

// --- KOMPONEN ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/50 p-6 ${className}`}>
    {children}
  </div>
);

const Navbar = ({ view, setView, logo }) => (
  <header className={`sticky top-0 z-[60] w-full backdrop-blur-xl border-b transition-all duration-300 ${view === 'Admin' ? 'bg-slate-900 border-slate-800 text-white' : 'bg-white/80 border-slate-100 text-slate-900'}`}>
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
      <div className="flex items-center space-x-4 cursor-pointer" onClick={() => setView('Public')}>
        <div className="w-12 h-12 flex items-center justify-center text-indigo-600 overflow-hidden">
          {logo ? <img src={logo} alt="Logo" className="w-full h-full object-contain" /> : <Sparkles size={32} />}
        </div>
        <div className="hidden sm:block">
          <h1 className="text-base font-black tracking-tighter uppercase leading-none">Unit Psikologi & Kaunseling</h1>
          <p className="text-[10px] font-bold opacity-60 tracking-widest uppercase mt-1">IPGM</p>
        </div>
      </div>

      <nav className="flex items-center space-x-1 sm:space-x-4">
        <button 
          onClick={() => setView('Public')}
          className={`px-4 py-2 rounded-xl text-xs font-black transition-all ${view === 'Public' ? 'bg-indigo-600 text-white' : 'hover:bg-slate-100'}`}
        >
          AWAM
        </button>
        <button 
          onClick={() => setView('Admin')}
          className={`px-4 py-2 rounded-xl text-xs font-black transition-all ${view === 'Admin' ? 'bg-white text-slate-900' : 'hover:bg-slate-100'}`}
        >
          ADMIN
        </button>
      </nav>
    </div>
  </header>
);

const PublicView = ({ ipgm, campuses, logo }) => {
  const [activeTab, setActiveTab] = useState('directory');
  const [subTab, setSubTab] = useState('ipgm');
  const [selectedCampusIdx, setSelectedCampusIdx] = useState(0);
  const [isAnalysing, setIsAnalysing] = useState(false);
  const [aiResult, setAiResult] = useState('');
  const [selectedTest, setSelectedTest] = useState('');
  const [searchTerm, setSearchTerm] = useState('');

  const filteredCampuses = campuses.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));
  const currentCampus = campuses[selectedCampusIdx] || campuses[0];

  const handleTestAnalysis = async (type) => {
    setSelectedTest(type);
    setIsAnalysing(true);
    setAiResult('');
    const prompt = `Berikan ulasan kaunseling inspirasi (3 ayat) untuk pelajar yang baru selesai menduduki ujian psikologi jenis: ${type}. Gunakan Bahasa Melayu yang profesional, empati, dan memberdayakan.`;
    const res = await callGemini(prompt, "Anda adalah Pakar Kaunselor IPGM yang mesra dan bijaksana.");
    setAiResult(res);
    setIsAnalysing(false);
  };

  return (
    <div className="max-w-7xl mx-auto px-4 py-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
      <div className="mb-12 relative rounded-[3rem] overflow-hidden bg-gradient-to-br from-indigo-600 to-violet-700 p-8 sm:p-16 text-white text-center">
        <div className="absolute top-0 left-0 w-full h-full opacity-10 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-white via-transparent to-transparent pointer-events-none" />
        <h2 className="text-3xl sm:text-5xl font-black mb-4 tracking-tight">Kesejahteraan Anda Keutamaan Kami</h2>
        <p className="text-indigo-100 max-w-2xl mx-auto font-medium text-sm sm:text-lg">Portal bersepadu perkhidmatan psikologi dan bimbingan untuk seluruh warga Institut Pendidikan Guru Malaysia.</p>
      </div>

      <div className="flex space-x-2 mb-8 overflow-x-auto pb-2 no-scrollbar">
        {[
          { id: 'directory', label: 'Direktori', icon: Users },
          { id: 'tests', label: 'Ujian Psikologi', icon: BrainCircuit },
          { id: 'resources', label: 'Sumber', icon: FileText },
          { id: 'booking', label: 'Temujanji', icon: Calendar }
        ].map(t => (
          <button
            key={t.id}
            onClick={() => setActiveTab(t.id)}
            className={`flex items-center space-x-2 px-6 py-3 rounded-full text-xs font-black whitespace-nowrap transition-all border-2 ${activeTab === t.id ? 'bg-indigo-600 border-indigo-600 text-white shadow-xl shadow-indigo-200' : 'bg-white border-slate-100 text-slate-500 hover:border-indigo-100'}`}
          >
            <t.icon size={16} />
            <span className="uppercase tracking-widest">{t.label}</span>
          </button>
        ))}
      </div>

      {activeTab === 'directory' && (
        <div className="space-y-8 animate-in fade-in duration-500">
          <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div className="flex p-1 bg-slate-100 rounded-2xl w-fit">
              <button onClick={() => setSubTab('ipgm')} className={`px-6 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all ${subTab === 'ipgm' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>IPGM Pusat</button>
              <button onClick={() => setSubTab('ipgk')} className={`px-6 py-2.5 rounded-xl text-[10px] font-black uppercase transition-all ${subTab === 'ipgk' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>Cawangan IPGK</button>
            </div>
            {subTab === 'ipgk' && (
              <div className="relative">
                <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
                <input 
                  type="text" 
                  placeholder="Cari kampus..." 
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-12 pr-6 py-3 bg-white border border-slate-200 rounded-2xl text-sm focus:ring-2 ring-indigo-500 outline-none w-full sm:w-64"
                />
              </div>
            )}
          </div>

          {subTab === 'ipgm' ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {ipgm.map((c) => (
                <Card key={c.id} className="group hover:translate-y-[-4px] transition-all duration-300">
                  <div className="flex items-center space-x-5">
                    <img src={c.image} className="w-20 h-20 rounded-2xl object-cover bg-slate-50" alt={c.name} />
                    <div>
                      <p className="text-[10px] font-black text-indigo-600 uppercase tracking-widest mb-1">{c.role}</p>
                      <h4 className="font-black text-slate-800 leading-tight">{c.name}</h4>
                    </div>
                  </div>
                </Card>
              ))}
            </div>
          ) : (
            <div className="grid lg:grid-cols-12 gap-8">
              <div className="lg:col-span-4 h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                <div className="grid gap-2">
                  {filteredCampuses.map((c) => (
                    <button
                      key={c.name}
                      onClick={() => setSelectedCampusIdx(campuses.indexOf(c))}
                      className={`text-left p-4 rounded-2xl text-xs font-bold border transition-all ${campuses[selectedCampusIdx]?.name === c.name ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg' : 'bg-white border-slate-100 hover:border-indigo-200'}`}
                    >
                      {c.name}
                    </button>
                  ))}
                </div>
              </div>
              <div className="lg:col-span-8">
                <Card className="h-full bg-slate-50 border-none shadow-none p-8 flex flex-col items-center justify-center text-center">
                  <div className="w-20 h-20 bg-indigo-100 rounded-[2rem] flex items-center justify-center text-indigo-600 mb-6">
                    <ImageIcon size={32} />
                  </div>
                  <h3 className="text-2xl font-black text-slate-800 mb-8">{currentCampus?.name}</h3>
                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full">
                    {[
                      { l: 'Ketua Kaunselor', v: currentCampus?.counselors?.ketua },
                      { l: 'Kaunselor Pentadbir', v: currentCampus?.counselors?.pentadbir },
                      { l: 'Kaunselor Pelajar', v: currentCampus?.counselors?.pelajar }
                    ].map((p, idx) => (
                      <div key={idx} className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <p className="text-[10px] font-black text-indigo-600 uppercase tracking-widest mb-3">{p.l}</p>
                        <p className="text-sm font-black text-slate-800">{p.v || '[Nama Pegawai]'}</p>
                      </div>
                    ))}
                  </div>
                </Card>
              </div>
            </div>
          )}
        </div>
      )}

      {activeTab === 'tests' && (
        <div className="max-w-4xl mx-auto space-y-8 animate-in zoom-in-95 duration-500">
          <div className="text-center space-y-2">
            <h3 className="text-2xl font-black text-slate-800">Analisis Psikologi AI</h3>
            <p className="text-slate-500 font-medium">Klik pada mana-mana ujian di bawah untuk mendapatkan ulasan awal dari kecerdasan buatan.</p>
          </div>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {['MINDA SIHAT', 'PERSONALITI', 'KERJAYA', 'PKPP', 'PKPW', 'INVENTORI STRES'].map(t => (
              <button 
                key={t} 
                onClick={() => handleTestAnalysis(t)}
                className={`bg-white p-8 rounded-[2.5rem] border-2 transition-all group text-center ${selectedTest === t ? 'border-indigo-600 shadow-lg' : 'border-slate-50 hover:border-indigo-400 hover:shadow-2xl'}`}
              >
                <div className="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition">
                  <BrainCircuit className="text-indigo-600" size={24} />
                </div>
                <span className="text-[10px] font-black tracking-widest uppercase">{t}</span>
              </button>
            ))}
          </div>
          {isAnalysing && (
            <div className="p-12 text-center space-y-4">
              <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mx-auto" />
              <p className="font-black text-indigo-600 text-xs tracking-[0.2em] uppercase italic">Gemini sedang merumus...</p>
            </div>
          )}
          {aiResult && !isAnalysing && (
            <div className="bg-indigo-950 text-white p-10 rounded-[3rem] shadow-2xl relative overflow-hidden group animate-in slide-in-from-top-4">
              <Sparkles className="absolute -top-4 -right-4 w-32 h-32 opacity-10 group-hover:rotate-12 transition-transform duration-700" />
              <div className="flex flex-col sm:flex-row items-start gap-6 relative">
                <div className="bg-white/10 p-4 rounded-2xl shrink-0"><Sparkles className="text-indigo-300" /></div>
                <div className="flex-grow">
                  <h4 className="font-black text-[10px] tracking-[0.3em] uppercase mb-4 text-indigo-300">Analisis Gemini AI ({selectedTest})</h4>
                  <p className="text-lg leading-relaxed italic font-medium mb-8">"{aiResult}"</p>
                  
                  {/* Butang Pautan Luar jika ada pautan (PKPP / PKPW) */}
                  {TEST_EXTERNAL_LINKS[selectedTest] && (
                    <a 
                      href={TEST_EXTERNAL_LINKS[selectedTest]} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="inline-flex items-center space-x-3 bg-white text-indigo-950 px-8 py-4 rounded-2xl font-black text-sm hover:bg-indigo-50 transition shadow-xl"
                    >
                      <span>BUKA LAMAN UJIAN</span>
                      <ExternalLink size={18} />
                    </a>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      )}

      {activeTab === 'resources' && (
        <div className="grid md:grid-cols-3 gap-8 animate-in fade-in duration-500">
          {POSTERS.map(p => (
            <div key={p.id} className="group cursor-pointer">
              <div className="relative aspect-[3/4] rounded-[2.5rem] overflow-hidden mb-4 shadow-xl">
                <img src={p.image} className="w-full h-full object-cover group-hover:scale-110 transition duration-700" alt={p.title} />
                <div className="absolute inset-0 bg-indigo-950/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                  <button className="bg-white text-indigo-950 px-6 py-3 rounded-full font-black text-xs shadow-2xl flex items-center space-x-2">
                    <Download size={14} />
                    <span>MUAT TURUN PDF</span>
                  </button>
                </div>
              </div>
              <h4 className="text-center font-black text-slate-800 text-sm px-4">{p.title}</h4>
            </div>
          ))}
        </div>
      )}

      {activeTab === 'booking' && (
        <Card className="p-0 overflow-hidden border-2 border-indigo-100 animate-in slide-in-from-bottom-8 duration-500">
          <div className="p-6 bg-indigo-50 border-b border-indigo-100 flex items-center justify-between">
            <div>
              <h3 className="font-black text-indigo-950 text-sm uppercase tracking-widest">Portal e2PK</h3>
              <p className="text-[10px] font-bold text-indigo-400">PENGURUSAN TEMUJANJI RASMI KPM</p>
            </div>
            <a href="https://e2pk.moe.gov.my" target="_blank" rel="noopener noreferrer" className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-black">BUKA PENUH</a>
          </div>
          <iframe 
            src="https://e2pk.moe.gov.my/inframe.cfm?temujanji" 
            className="w-full h-[600px] border-none grayscale hover:grayscale-0 transition duration-1000"
            title="Temujanji e2PK"
          />
        </Card>
      )}
    </div>
  );
};

const AdminDashboard = ({ ipgm, setIpgm, campuses, setCampuses, logo, setLogo, user }) => {
  const [activeMenu, setActiveMenu] = useState('stats');
  const [editingCampus, setEditingCampus] = useState(null);
  const [editingOfficer, setEditingOfficer] = useState(null);
  const [memoInput, setMemoInput] = useState({ topic: '', recipient: '', type: 'Memo' });
  const [memoOutput, setMemoOutput] = useState('');
  const [isGenerating, setIsGenerating] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  const saveToCloud = async () => {
    if (!user) return;
    setIsSaving(true);
    try {
      const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'portalSettings', 'current');
      await setDoc(publicRef, { 
        ipgm, 
        campuses, 
        logo,
        lastUpdated: new Date().toISOString()
      });
    } catch (e) {
      console.error("Ralat simpan:", e);
    } finally {
      setIsSaving(false);
    }
  };

  const generateMemo = async () => {
    setIsGenerating(true);
    const prompt = `Drafkan satu ${memoInput.type} rasmi daripada Unit Psikologi & Kaunseling IPGM mengenai topik: ${memoInput.topic}. Penerima: ${memoInput.recipient}. Pastikan struktur rasmi: No Rujukan (Gunakan XXX), Tarikh, Tajuk, dan 3 perenggan utama yang profesional.`;
    const res = await callGemini(prompt, "Anda adalah pegawai bimbingan kanan yang pakar dalam penulisan surat rasmi kerajaan.");
    setMemoOutput(res);
    setIsGenerating(false);
  };

  const getStatColor = (color) => {
    switch (color) {
      case 'indigo': return 'text-indigo-600';
      case 'green': return 'text-green-600';
      case 'red': return 'text-red-600';
      default: return 'text-slate-600';
    }
  };

  return (
    <div className="flex flex-col md:flex-row min-h-[calc(100vh-80px)] bg-slate-50">
      <aside className="w-full md:w-72 bg-white border-r border-slate-200 p-8 flex flex-col">
        <div className="flex items-center space-x-3 mb-10 px-4">
          <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white"><UserCircle /></div>
          <div className="overflow-hidden">
            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Admin Portal</p>
            <p className="text-xs font-black text-slate-800 truncate">{user?.uid ? user.uid.substring(0, 12) : 'Pengguna'}</p>
          </div>
        </div>

        <nav className="space-y-2 flex-grow">
          {[
            { id: 'stats', label: 'Statistik', icon: LayoutDashboard },
            { id: 'data', label: 'Data Pegawai', icon: Users },
            { id: 'memo', label: 'Penjana AI', icon: FileText },
            { id: 'settings', label: 'Tetapan', icon: Settings }
          ].map(m => (
            <button
              key={m.id}
              onClick={() => setActiveMenu(m.id)}
              className={`w-full flex items-center space-x-3 px-6 py-4 rounded-2xl text-xs font-black transition-all ${activeMenu === m.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-100' : 'text-slate-500 hover:bg-slate-50'}`}
            >
              <m.icon size={18} />
              <span className="uppercase tracking-widest">{m.label}</span>
            </button>
          ))}
        </nav>

        <div className="mt-10 pt-10 border-t border-slate-100 space-y-4">
          <button 
            onClick={saveToCloud}
            disabled={isSaving}
            className="w-full flex items-center justify-center space-x-2 bg-green-600 text-white py-4 rounded-2xl text-xs font-black hover:bg-green-700 transition"
          >
            <Save size={16} />
            <span>{isSaving ? 'MENYIMPAN...' : 'SIMPAN KE AWAN'}</span>
          </button>
          <button 
            onClick={() => window.location.reload()}
            className="w-full flex items-center justify-center space-x-2 text-red-500 py-4 rounded-2xl text-xs font-black hover:bg-red-50 transition"
          >
            <LogOut size={16} />
            <span>LOG KELUAR</span>
          </button>
        </div>
      </aside>

      <main className="flex-grow p-6 sm:p-12 overflow-y-auto">
        {activeMenu === 'stats' && (
          <div className="space-y-10 animate-in fade-in duration-500">
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-6">
              {[
                { l: 'Sesi Bulan Ini', v: '182', c: 'indigo' },
                { l: 'Kes Selesai', v: '94%', c: 'green' },
                { l: 'Pelajar Dirujuk', v: '12', c: 'red' }
              ].map((s, i) => (
                <Card key={i} className="border-none shadow-sm">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">{s.l}</p>
                  <h4 className={`text-4xl font-black ${getStatColor(s.c)}`}>{s.v}</h4>
                </Card>
              ))}
            </div>
            <Card className="h-[400px]">
              <h3 className="text-xs font-black text-slate-800 uppercase tracking-widest mb-8">Pecahan Isu Psikologi (Tahunan)</h3>
              <ResponsiveContainer width="100%" height="100%">
                <BarChart data={CASE_STATS}>
                  <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                  <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fontSize: 10, fontWeight: 700}} />
                  <YAxis axisLine={false} tickLine={false} tick={{fontSize: 10, fontWeight: 700}} />
                  <Tooltip cursor={{fill: '#f8fafc'}} contentStyle={{ borderRadius: '16px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)' }} />
                  <Bar dataKey="count" radius={[10, 10, 0, 0]} fill="#6366f1">
                    {CASE_STATS.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={index % 2 === 0 ? '#6366f1' : '#8b5cf6'} />
                    ))}
                  </Bar>
                </BarChart>
              </ResponsiveContainer>
            </Card>
          </div>
        )}

        {activeMenu === 'data' && (
          <div className="space-y-8 animate-in fade-in duration-500">
            <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
              <h3 className="text-xs font-black text-slate-800 uppercase tracking-[0.2em] mb-6">Unit Psikologi IPGM Pusat</h3>
              <div className="grid sm:grid-cols-2 gap-4">
                {ipgm.map(officer => (
                  <div key={officer.id} className="p-5 bg-slate-50 rounded-2xl flex justify-between items-center group">
                    <div>
                      <p className="text-[10px] font-black text-indigo-600 mb-1">{officer.role}</p>
                      <p className="font-black text-sm text-slate-800">{officer.name}</p>
                    </div>
                    <button 
                      onClick={() => setEditingOfficer(officer)}
                      className="opacity-0 group-hover:opacity-100 p-3 bg-white text-indigo-600 rounded-xl shadow-sm transition-all"
                    >
                      <Settings size={14} />
                    </button>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
              <h3 className="text-xs font-black text-slate-800 uppercase tracking-[0.2em] mb-6">Senarai Kampus IPGK ({campuses.length})</h3>
              <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                {campuses.map((c, i) => (
                  <button
                    key={i}
                    onClick={() => setEditingCampus(i)}
                    className="p-4 bg-slate-50 border border-slate-100 rounded-2xl text-[10px] font-black hover:bg-indigo-600 hover:text-white transition-all text-left uppercase truncate"
                  >
                    {c.name}
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}

        {activeMenu === 'memo' && (
          <div className="grid lg:grid-cols-2 gap-10 animate-in slide-in-from-right-8 duration-500">
            <Card className="p-10 flex flex-col space-y-6">
              <h3 className="text-xl font-black text-slate-800 tracking-tight">Draf Dokumen Rasmi AI</h3>
              <div className="space-y-4">
                <div className="space-y-2">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Jenis Dokumen</label>
                  <select 
                    value={memoInput.type} 
                    onChange={e => setMemoInput({...memoInput, type: e.target.value})}
                    className="w-full p-4 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 outline-none font-black text-xs"
                  >
                    <option>Memo Dalaman</option>
                    <option>Surat Rasmi</option>
                    <option>Hebahan</option>
                  </select>
                </div>
                <div className="space-y-2">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Penerima</label>
                  <input 
                    type="text" 
                    placeholder="Contoh: Pengarah IPGK..." 
                    value={memoInput.recipient}
                    onChange={e => setMemoInput({...memoInput, recipient: e.target.value})}
                    className="w-full p-4 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 outline-none text-sm font-medium"
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Intipati / Tujuan</label>
                  <textarea 
                    placeholder="Terangkan tujuan dokumen ini dijana..." 
                    rows={4}
                    value={memoInput.topic}
                    onChange={e => setMemoInput({...memoInput, topic: e.target.value})}
                    className="w-full p-4 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 outline-none text-sm font-medium"
                  />
                </div>
                <button 
                  onClick={generateMemo}
                  disabled={isGenerating || !memoInput.topic}
                  className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-indigo-100 flex items-center justify-center space-x-2 disabled:opacity-50"
                >
                  <Sparkles size={16} />
                  <span>{isGenerating ? 'SEDANG MENJANA...' : 'JANA DRAF DENGAN GEMINI'}</span>
                </button>
              </div>
            </Card>

            <div className="bg-slate-900 rounded-[3rem] p-10 text-white shadow-2xl relative flex flex-col min-h-[400px]">
              <div className="absolute top-8 right-10 text-[10px] font-black opacity-30 tracking-[0.3em]">HASIL AI</div>
              <div className="flex-grow overflow-y-auto custom-scrollbar pr-4">
                <p className="text-sm font-mono leading-relaxed opacity-80 whitespace-pre-wrap">
                  {memoOutput || 'Draf dokumen anda akan muncul di sini setelah dijana...'}
                </p>
              </div>
              {memoOutput && (
                <button 
                  onClick={() => {
                    navigator.clipboard.writeText(memoOutput);
                  }}
                  className="mt-8 w-full py-4 rounded-2xl bg-white/10 hover:bg-white/20 text-white text-xs font-black transition-all flex items-center justify-center space-x-2"
                >
                  <FileText size={16} />
                  <span>SALIN TEKS DOKUMEN</span>
                </button>
              )}
            </div>
          </div>
        )}

        {activeMenu === 'settings' && (
          <div className="max-w-2xl animate-in fade-in duration-500">
            <Card className="p-10 space-y-10">
              <div>
                <h3 className="text-xl font-black text-slate-800 mb-2">Identiti Visual</h3>
                <p className="text-sm text-slate-500 font-medium">Uruskan logo dan penjenamaan portal anda.</p>
              </div>
              
              <div className="flex items-center space-x-8">
                <div className="w-32 h-32 bg-slate-50 rounded-[2.5rem] border-4 border-white shadow-inner flex items-center justify-center overflow-hidden">
                  {logo ? <img src={logo} className="w-full h-full object-cover" alt="Logo" /> : <ImageIcon className="text-slate-200" size={40} />}
                </div>
                <div className="space-y-4">
                  <label className="block bg-indigo-600 text-white px-6 py-3 rounded-2xl text-xs font-black cursor-pointer shadow-lg hover:bg-indigo-700 transition">
                    MUAT NAIK LOGO BARU
                    <input 
                      type="file" 
                      className="hidden" 
                      accept="image/*"
                      onChange={(e) => {
                        const file = e.target.files?.[0];
                        if (file) {
                          const reader = new FileReader();
                          reader.onloadend = () => setLogo(reader.result);
                          reader.readAsDataURL(file);
                        }
                      }}
                    />
                  </label>
                  <button onClick={() => setLogo(null)} className="block text-[10px] font-black text-red-500 uppercase tracking-widest hover:underline">Hapuskan Logo</button>
                </div>
              </div>

              <div className="pt-10 border-t border-slate-100">
                <h4 className="text-sm font-black text-slate-800 mb-4">Integrasi Sistem</h4>
                <div className="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex items-center justify-between">
                  <div className="flex items-center space-x-3">
                    <div className="w-8 h-8 bg-green-100 text-green-600 rounded-lg flex items-center justify-center"><CheckCircle2 size={16} /></div>
                    <span className="text-xs font-bold text-slate-600 uppercase tracking-widest">Firestore Cloud Storage</span>
                  </div>
                  <span className="text-[10px] font-black text-green-600">AKTIF</span>
                </div>
              </div>
            </Card>
          </div>
        )}
      </main>

      {/* Modal Kemaskini Pegawai */}
      {editingOfficer && (
        <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6">
          <Card className="max-w-md w-full p-10 animate-in slide-in-from-bottom-10">
            <h4 className="text-xl font-black text-slate-800 mb-8">Kemas Kini Pegawai</h4>
            <div className="space-y-4 mb-8">
              <div className="space-y-2">
                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Nama Penuh</label>
                <input 
                  type="text" 
                  value={editingOfficer.name} 
                  onChange={e => setEditingOfficer({...editingOfficer, name: e.target.value})}
                  className="w-full p-4 rounded-2xl border-2 border-slate-100 focus:border-indigo-500 outline-none font-bold"
                />
              </div>
              <div className="space-y-2">
                <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Jawatan / Peranan</label>
                <input 
                  type="text" 
                  value={editingOfficer.role} 
                  onChange={e => setEditingOfficer({...editingOfficer, role: e.target.value})}
                  className="w-full p-4 rounded-2xl border-2 border-slate-100 focus:border-indigo-500 outline-none font-bold"
                />
              </div>
            </div>
            <div className="flex space-x-3">
              <button 
                onClick={() => {
                  setIpgm(ipgm.map(o => o.id === editingOfficer.id ? editingOfficer : o));
                  setEditingOfficer(null);
                }}
                className="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg"
              >
                SIMPAN
              </button>
              <button onClick={() => setEditingOfficer(null)} className="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black">BATAL</button>
            </div>
          </Card>
        </div>
      )}

      {/* Modal Kemaskini Kampus */}
      {editingCampus !== null && campuses[editingCampus] && (
        <div className="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-6">
          <Card className="max-w-lg w-full p-10 animate-in slide-in-from-bottom-10 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <h4 className="text-xl font-black text-slate-800 mb-8 uppercase tracking-tighter">Edit: {campuses[editingCampus].name}</h4>
            <div className="space-y-6 mb-10">
              {['ketua', 'pentadbir', 'pelajar'].map(key => (
                <div key={key} className="space-y-2">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Kaunselor {key.toUpperCase()}</label>
                  <input 
                    type="text" 
                    value={campuses[editingCampus].counselors?.[key] || ''} 
                    onChange={e => {
                      const newCampuses = [...campuses];
                      if (!newCampuses[editingCampus].counselors) newCampuses[editingCampus].counselors = {};
                      newCampuses[editingCampus].counselors[key] = e.target.value;
                      setCampuses(newCampuses);
                    }}
                    className="w-full p-4 rounded-2xl border-2 border-slate-100 focus:border-indigo-500 outline-none font-bold"
                  />
                </div>
              ))}
            </div>
            <button 
              onClick={() => setEditingCampus(null)}
              className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg"
            >
              SELESAI
            </button>
          </Card>
        </div>
      )}
    </div>
  );
};

const LoginView = ({ onLogin, error }) => {
  const [password, setPassword] = useState('');

  return (
    <div className="min-h-[80vh] flex items-center justify-center px-4 animate-in fade-in zoom-in-95 duration-700">
      <Card className="max-w-md w-full p-12 text-center border-2 border-slate-50">
        <div className="w-20 h-20 bg-indigo-600 rounded-[2rem] flex items-center justify-center text-white mx-auto mb-8 shadow-xl">
          <Lock size={32} />
        </div>
        <h2 className="text-2xl font-black text-slate-800 mb-2">Akses Terhad</h2>
        <p className="text-sm text-slate-500 font-medium mb-10">Sila masukkan kata laluan pentadbir untuk menguruskan portal.</p>
        
        <form onSubmit={e => { e.preventDefault(); onLogin(password); }} className="space-y-4">
          <input 
            type="password" 
            placeholder="KATA LALUAN" 
            value={password}
            onChange={e => setPassword(e.target.value)}
            className="w-full px-6 py-4 rounded-2xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 outline-none text-center font-black transition-all"
          />
          {error && (
            <div className="p-4 bg-red-50 border border-red-100 rounded-xl text-red-500 text-[10px] font-black flex items-center justify-center space-x-2">
              <AlertCircle size={14} />
              <span>{error}</span>
            </div>
          )}
          <button 
            type="submit" 
            className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition transform active:scale-95"
          >
            LOG MASUK ADMIN
          </button>
        </form>
        <p className="mt-8 text-[10px] font-black text-slate-300 uppercase tracking-widest">Default: admin123</p>
      </Card>
    </div>
  );
};

export default function App() {
  const [view, setView] = useState('Public');
  const [isAuth, setIsAuth] = useState(false);
  const [user, setUser] = useState(null);
  const [error, setError] = useState('');
  const [logo, setLogo] = useState(null);

  const initialIpgm = [
    { id: '1', name: 'Dr. Noor Azmi bin Haji Ibrahim', role: 'Ketua Penolong Pengarah (UPsk)', category: 'IPGM', image: 'https://images.unsplash.com/photo-1560250097-0b93528c311a?auto=format&fit=crop&q=80&w=400' },
    { id: '2', name: 'Pn. Siti Mariam binti Abdullah', role: 'Penolong Pengarah Kanan', category: 'IPGM', image: 'https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?auto=format&fit=crop&q=80&w=400' }
  ];

  const [ipgm, setIpgm] = useState(initialIpgm);
  const [campuses, setCampuses] = useState(CAMPUS_NAMES.map(n => ({
    name: n, 
    counselors: { ketua: '[Nama Pegawai]', pentadbir: '[Nama Pegawai]', pelajar: '[Nama Pegawai]' }
  })));

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
          await signInWithCustomToken(auth, window.__initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error("Ralat pengesahan:", e);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
    });
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'portalSettings', 'current');
      const unsubscribe = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          if (data.ipgm) setIpgm(data.ipgm);
          if (data.campuses) setCampuses(data.campuses);
          if (data.logo) setLogo(data.logo);
        }
      }, (err) => console.error("Ralat bacaan Firestore:", err));
      return () => unsubscribe();
    } catch (e) {
      console.error("Ralat permulaan Firestore:", e);
    }
  }, [user]);

  const handleLogin = (p) => {
    if (p === 'admin123') {
      setIsAuth(true);
      setError('');
    } else {
      setError('KATA LALUAN SALAH');
    }
  };

  return (
    <div className="min-h-screen flex flex-col font-['Plus_Jakarta_Sans',sans-serif] bg-white text-slate-900 selection:bg-indigo-100 selection:text-indigo-900">
      <Navbar view={view} setView={setView} logo={logo} />
      
      <main className="flex-grow">
        {view === 'Admin' ? (
          !isAuth ? (
            <LoginView onLogin={handleLogin} error={error} />
          ) : (
            <AdminDashboard 
              ipgm={ipgm} setIpgm={setIpgm} 
              campuses={campuses} setCampuses={setCampuses}
              logo={logo} setLogo={setLogo}
              user={user}
            />
          )
        ) : (
          <PublicView ipgm={ipgm} campuses={campuses} logo={logo} />
        )}
      </main>

      <footer className="bg-slate-50 border-t border-slate-100 py-16 px-6">
        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-8">
          <div className="text-center md:text-left">
            <h5 className="font-black text-lg text-slate-800 tracking-tighter uppercase mb-2">Unit Psikologi & Kaunseling</h5>
            <p className="text-xs text-indigo-600 font-black tracking-widest uppercase mb-4">IPGM</p>
            <p className="text-xs text-slate-400 font-bold max-w-sm leading-relaxed uppercase tracking-widest">
              Komited ke arah kesejahteraan holistik warga IPGKPM.
            </p>
          </div>
          <div className="flex space-x-6 text-[10px] font-black text-slate-400 uppercase tracking-widest">
            <a href="#" className="hover:text-indigo-600 transition">Privasi</a>
            <a href="#" className="hover:text-indigo-600 transition">Terma</a>
            <a href="#" className="hover:text-indigo-600 transition">Hubungi Kami</a>
          </div>
        </div>
        <div className="max-w-7xl mx-auto mt-12 pt-8 border-t border-slate-200/50 text-center">
          <p className="text-[10px] font-black text-slate-300 uppercase tracking-[0.3em]">
            &copy; 2024 INSTITUT PENDIDIKAN GURU MALAYSIA. HAK CIPTA TERPELIHARA.
          </p>
        </div>
      </footer>

      <style dangerouslySetInnerHTML={{ __html: `
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input::placeholder, textarea::placeholder { font-weight: 700; color: #cbd5e1; font-size: 12px; letter-spacing: 0.05em; text-transform: uppercase; }
      `}} />
    </div>
  );
}
