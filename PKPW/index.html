<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Kesejahteraan dan Personaliti Warga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar-animated {
            transition: width 0.5s ease-in-out;
        }
        .radio-container label {
            transition: all 0.2s ease-in-out;
        }
        .radio-container input:checked + label {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .welcome-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .welcome-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 bg-white min-h-screen shadow-lg rounded-lg my-8">
        <!-- App content will be rendered here -->
        <div class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Memuatkan soal selidik...</p>
        </div>
    </div>
    <div id="modal-container"></div>
    <footer class="text-center py-4 text-sm text-gray-500">
        Â© 2024 Unit Psikologi dan Kaunseling, IPGM
    </footer>

    <script>
        // --- STATE MANAGEMENT ---
        let state = {
            currentSection: -1, 
            showResults: false,
            responses: { demographics: {}, personality: {}, wellbeing: {}, resilience: {} },
            submittedEmails: new Set()
        };

        // --- QUESTIONNAIRE DATA ---
        const demographicsQuestions = [
            { id: 'name', label: 'Nama Penuh', type: 'text', required: true },
            { id: 'email', label: 'Alamat Email', type: 'email', required: true },
            { id: 'gender', label: 'Jantina', type: 'select', options: ['Lelaki', 'Perempuan'], required: true },
            { id: 'race', label: 'Bangsa', type: 'select', options: ['Melayu', 'Cina', 'India', 'Bumiputera Sabah/Sarawak', 'Lain-lain'], required: true },
            { id: 'religion', label: 'Agama', type: 'select', options: ['Islam', 'Buddha', 'Kristian', 'Hindu', 'Lain-lain'], required: true },
            { id: 'phone', label: 'No. Telefon (Bimbit)', type: 'tel', required: true },
            { id: 'ipgKampus', label: 'IPGM/IPGK', type: 'select', options: ['Institut Pendidikan Guru Malaysia (IPGM)', 'IPG Kampus Bahasa Melayu', 'IPG Kampus Bahasa Antarabangsa', 'IPG Kampus Ilmu Khas', 'IPG Kampus Pendidikan Islam', 'IPG Kampus Pendidikan Teknik', 'IPG Kampus Raja Melewar', 'IPG Kampus Tun Hussein Onn', 'IPG Kampus Temenggong Ibrahim', 'IPG Kampus Perempuan Melayu Melaka', 'IPG Kampus Ipoh', 'IPG Kampus Pulau Pinang', 'IPG Kampus Tuanku Bainun', 'IPG Kampus Perlis', 'IPG Kampus Darul Aman', 'IPG Kampus Sultan Abdul Halim', 'IPG Kampus Tengku Ampuan Afzan', 'IPG Kampus Dato\' Razali Ismail', 'IPG Kampus Sultan Mizan', 'IPG Kampus Kota Bharu', 'IPG Kampus Kent', 'IPG Kampus Gaya', 'IPG Kampus Keningau', 'IPG Kampus Tawau', 'IPG Kampus Batu Lintang', 'IPG Kampus Sarawak', 'IPG Kampus Rajang', 'IPG Kampus Tun Abdul Razak', 'English Language Teaching Centre (ELTC)'], required: true },
            { id: 'jawatan', label: 'Jawatan', type: 'select', options: ['REKTOR', 'TIMBALAN REKTOR KANAN', 'TIMBALAN REKTOR', 'KETUA PENOLONG PENGARAH', 'PENOLONG PENGARAH', 'PENGARAH', 'TIMBALAN PENGARAH', 'KETUA JABATAN', 'KETUA UNIT', 'KETUA KAUNSELOR PENDIDIKAN','PENSYARAH', 'KAUNSELOR PENDIDIKAN', 'PEGAWAI PENGURUSAN', 'PEGAWAI GUNASAMA', 'ANGGOTA KUMPULAN PELAKSANA (AKP)'], required: true },
            { id: 'gred', label: 'Gred', type: 'select', options: ['JUSA B', 'JUSA C', 'DG15', 'DG14', 'DG13', 'DG12', 'DG10', 'DG9', 'F12', 'F11', 'F10', 'F9', 'F8', 'F7', 'F6', 'F5', 'F4', 'F3', 'F2', 'F1', 'S10', 'S9', 'S8', 'S7', 'S6', 'S5', 'S4', 'S3', 'S2', 'S1', 'W11', 'W10', 'W9', 'W8', 'W7', 'W6', 'W5', 'W4', 'W3', 'W2', 'W1', 'M12', 'M11', 'M10', 'M9', 'N10', 'N9', 'N8', 'N7', 'N6', 'N5', 'N4', 'N3', 'N2', 'N1', 'H2', 'H1'], required: true }
        ];
        const personalityQuestions = [ 'Saya seorang yang menceriakan suasana majlis.', 'Saya kurang mengambil berat tentang orang lain.', 'Saya sentiasa bersedia.', 'Saya mudah berasa tertekan.', 'Saya mempunyai kosa kata yang luas.', 'Saya tidak banyak bercakap.', 'Saya cenderung untuk berurusan dengan orang lain.', 'Saya sering tertinggal barang di merata tempat.', 'Saya tenang pada kebanyakan masa.', 'Saya sukar memahami idea-idea abstrak.', 'Saya berasa selesa dikelilingi orang ramai.', 'Saya sering menghina orang lain.', 'Saya memberikan tumpuan kepada sesuatu perkara secara terperinci.', 'Saya sering bimbang tentang sesuatu perkara.', 'Saya mempunyai imaginasi yang jelas.', 'Saya suka laksanakan tugas di belakang tabir.', 'Saya simpati dengan perasaan orang lain.', 'Saya sering membuat keadaan menjadi kucar-kacir.', 'Saya jarang berasa sedih.', 'Saya tidak berminat dengan idea-idea abstrak.', 'Saya selalu memulakan perbualan dengan orang lain.', 'Saya tidak berminat dengan masalah orang lain.', 'Saya menyelesaikan tugas dengan segera.', 'Saya mudah terganggu.', 'Saya mempunyai idea-idea yang bernas.', 'Saya kurang bercakap.', 'Saya seorang yang berhati lembut.', 'Saya sering lupa meletakkan kembali barang ke tempat asal.', 'Saya mudah berasa kecewa.', 'Saya tidak mempunyai imaginasi yang baik.', 'Saya selesa berbual dengan ramai orang di sesuatu majlis.', 'Saya tidak berminat berurusan dengan orang lain.', 'Saya suka kepada keteraturan.', 'Hati saya kerap berubah-ubah.', 'Saya cepat memahami sesuatu perkara.', 'Saya tidak suka memberi perhatian kepada diri sendiri.', 'Saya meluangkan masa untuk orang lain.', 'Saya mengelak daripada tanggungjawab.', 'Saya kerap mengalami perubahan emosi.', 'Saya sering menggunakan perkataan yang sukar.', 'Saya tidak kisah menjadi perhatian orang lain.', 'Saya memahami perasaan orang lain.', 'Saya seorang yang mengikut jadual.', 'Saya mudah rasa terganggu.', 'Saya selalu meluangkan masa meneliti sesuatu perkara.', 'Saya akan diam apabila bersama orang yang tidak dikenali.', 'Saya selalu membuat orang lain berasa selesa.', 'Saya teliti dalam kerja saya.', 'Saya sering berasa sedih.', 'Saya seorang yang banyak idea.' ];
        const wellbeingQuestions = ['Saya rasa optimis dengan masa depan', 'Saya rasa diri saya berguna', 'Saya rasa tenang', 'Saya menangani masalah dengan baik', 'Saya berfikir dengan jelas', 'Saya rasa dekat dengan orang lain', 'Saya boleh membuat keputusan sendiri', 'Saya rasa baik tentang diri saya', 'Saya berasa yakin', 'Saya dapat menikmati aktiviti harian saya', 'Saya boleh membuat keputusan terhadap sesuatu perkara', 'Saya rasa disayangi', 'Saya berminat dengan perkara baharu', 'Saya rasa ceria'];
        const resilienceQuestions = [ 'Saya cenderung segera bangkit semula daripada kesukaran.', 'Saya berasa sukar untuk hadapi situasi yang tertekan.', 'Saya tidak memerlukan masa yang lama untuk bangkit semula daripada situasi sukar.', 'Sukar untuk saya bangkit semula setelah berlaku sesuatu yang buruk.', 'Saya cepat pulih semula apabila menghadapi situasi yang sukar.', 'Saya cenderung mengambil masa yang panjang untuk pulih daripada kekecewaan dalam hidup saya.' ];

        // --- EVENT HANDLERS & STATE UPDATERS ---
        window.startSurvey = function() { state.currentSection = 0; render(); window.scrollTo(0, 0); }
        window.handleDemographicChange = function(id, value) {
            const inputElement = document.getElementById(id);
            if (id === 'phone') {
                let digitsOnly = value.replace(/\D/g, '');
                state.responses.demographics[id] = digitsOnly;
                if (inputElement) { inputElement.value = digitsOnly; }
            } else {
                state.responses.demographics[id] = value;
            }
        }
        window.handlePersonalityChange = function(index, value) { state.responses.personality[index] = parseInt(value); updateRadioButtonVisual('personality', index, value); }
        window.handleWellbeingChange = function(index, value) { state.responses.wellbeing[index] = parseInt(value); updateRadioButtonVisual('wellbeing', index, value); }
        window.handleResilienceChange = function(index, value) { state.responses.resilience[index] = parseInt(value); updateRadioButtonVisual('resilience', index, value); }
        function updateRadioButtonVisual(section, index, selectedValue) {
            document.querySelectorAll(`input[name="${section}-${index}"]`).forEach(button => {
                const label = button.nextElementSibling;
                const baseClass = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 cursor-pointer';
                let specificClass = 'bg-gray-200 text-gray-600 hover:bg-gray-300';
                if (parseInt(button.value) === parseInt(selectedValue)) {
                    let colorClass = 'bg-blue-600';
                    if (section === 'wellbeing') colorClass = 'bg-green-600';
                    if (section === 'resilience') colorClass = 'bg-indigo-600';
                    specificClass = `${colorClass} text-white shadow-lg transform scale-110`;
                }
                label.className = `${baseClass} ${specificClass}`;
            });
        }
        function validateCurrentSection() {
            if (state.currentSection === 0) {
                for (const field of demographicsQuestions) {
                    if (field.required && !state.responses.demographics[field.id]) return { isValid: false, message: `Sila lengkapkan maklumat: ${field.label}.` };
                }
                const email = state.responses.demographics.email;
                if (email && state.submittedEmails.has(email.toLowerCase())) return { isValid: false, message: 'Alamat emel ini telah digunakan untuk menjawab soal selidik.' };
            } else if (state.currentSection === 1 && Object.keys(state.responses.personality).length < personalityQuestions.length) {
                return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian B.' };
            } else if (state.currentSection === 2 && Object.keys(state.responses.wellbeing).length < wellbeingQuestions.length) {
                return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian C.' };
            } else if (state.currentSection === 3 && Object.keys(state.responses.resilience).length < resilienceQuestions.length) {
                return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian D.' };
            }
            return { isValid: true };
        }
        window.handleNextSection = function() {
            const validation = validateCurrentSection();
            if (!validation.isValid) { showModal(validation.message); return; }
            state.currentSection++; render(); window.scrollTo(0, 0);
        }
        window.handlePrevSection = function() {
            state.currentSection = Math.max(0, state.currentSection - 1); render(); window.scrollTo(0, 0);
        }

        // --- SCORE CALCULATIONS ---
        function calculatePersonalityScores() {
            const r = state.responses.personality;
            const p = (index) => r[index - 1] || 3;
            const reverse = (score) => 6 - score;
            const scores = {
                extraversion: p(1) + reverse(p(6)) + p(11) + reverse(p(16)) + p(21) + reverse(p(26)) + p(31) + reverse(p(36)) + p(41) + reverse(p(46)),
                agreeableness: reverse(p(2)) + p(7) + reverse(p(12)) + p(17) + reverse(p(22)) + p(27) + reverse(p(32)) + p(37) + p(42) + p(47),
                conscientiousness: p(3) + reverse(p(8)) + p(13) + reverse(p(18)) + p(23) + reverse(p(28)) + p(33) + reverse(p(38)) + p(43) + p(48),
                neuroticism: p(4) + reverse(p(9)) + p(14) + reverse(p(19)) + p(24) + p(29) + p(34) + p(39) + p(44) + p(49),
                openness: p(5) + reverse(p(10)) + p(15) + reverse(p(20)) + p(25) + reverse(p(30)) + p(35) + p(40) + p(45) + p(50)
            };
            const toPercent = (score) => Math.round(((score - 10) / 40) * 100);
            return {
                extraversion: toPercent(scores.extraversion),
                agreeableness: toPercent(scores.agreeableness),
                conscientiousness: toPercent(scores.conscientiousness),
                neuroticism: toPercent(scores.neuroticism),
                openness: toPercent(scores.openness)
            };
        }
        function calculateWellbeingScore() {
            const totalScore = Object.values(state.responses.wellbeing).reduce((sum, score) => sum + (score || 0), 0);
            return { total: totalScore };
        }
        function calculateResilienceScore() {
            const r = state.responses.resilience;
            const reverseScore = (score) => 6 - score;
            const scores = [r[0], reverseScore(r[1]), r[2], reverseScore(r[3]), r[4], reverseScore(r[5])];
            const totalScore = scores.reduce((sum, score) => sum + (score || 3), 0);
            const meanScore = totalScore / resilienceQuestions.length;
            return { mean: parseFloat(meanScore.toFixed(2)) };
        }

        // --- DATA SUBMISSION & RESULTS FLOW ---
        async function sendToGoogleSheets(data) {
            const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzbutt0Oeg7211Bl8oXspkQlxUZBhcaH5Xpg5tJ9WWp8XV2y5UuSEr4bjoAu_laiBmYnA/exec';
            try {
                await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST', 
                    mode: 'no-cors',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify(data)
                });
                console.log('â Data submission attempted. Check Google Sheets for result.');
            } catch (error) {
                console.error('â Error sending data to Google Sheets:', error);
                showModal("Maaf, terdapat ralat semasa menghantar data anda. Sila cuba lagi.");
            }
        }
        
        window.processAndShowPopup = function() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                showModal(validation.message);
                return;
            }
            const email = state.responses.demographics.email;
            if (email) {
                state.submittedEmails.add(email.toLowerCase());
            }
            
            const personalityScores = calculatePersonalityScores();
            const wellbeingScore = calculateWellbeingScore();
            const resilienceScore = calculateResilienceScore();
            const personalityRanked = Object.entries(personalityScores).sort(([, a], [, b]) => b - a).map(([key]) => key);
            const getTahap = (score) => (score >= 67 ? 'Tinggi' : 'Sederhana');
            const getWellbeingTahap = (total) => (total >= 45 ? "Tinggi" : total >= 25 ? "Sederhana" : "Rendah");
            const getResilienceTahap = (mean) => (mean > 4.3 ? 'Tinggi' : mean >= 3.0 ? 'Normal' : 'Rendah');

            const sheetData = {
                timestamp: new Date().toLocaleString('en-GB', { timeZone: 'Asia/Kuala_Lumpur' }),
                ...state.responses.demographics,
                phone: `+60${state.responses.demographics.phone || ''}`,
                ...personalityScores,
                tahap_extraversion: getTahap(personalityScores.extraversion),
                tahap_agreeableness: getTahap(personalityScores.agreeableness),
                tahap_conscientiousness: getTahap(personalityScores.conscientiousness),
                tahap_neuroticism: getTahap(personalityScores.neuroticism),
                tahap_openness: getTahap(personalityScores.openness),
                domain_1: personalityRanked[0] || '', domain_2: personalityRanked[1] || '', domain_3: personalityRanked[2] || '',
                ...Object.fromEntries(Array.from({length: 50}, (_, i) => [`p${i+1}`, state.responses.personality[i] || 0])),
                wellbeingTotal: wellbeingScore.total,
                tahap_kesejahteraan: getWellbeingTahap(wellbeingScore.total),
                ...Object.fromEntries(Array.from({length: 14}, (_, i) => [`w${i+1}`, state.responses.wellbeing[i] || 0])),
                resilienceMean: resilienceScore.mean,
                tahap_daya_tahan: getResilienceTahap(resilienceScore.mean),
                ...Object.fromEntries(Array.from({length: 6}, (_, i) => [`d${i+1}`, state.responses.resilience[i] || 0]))
            };
            sendToGoogleSheets(sheetData);
            
            showDownloadPopup();
        }

        window.displayAndDownload = function() {
            state.showResults = true;
            render();
            window.scrollTo(0, 0);
            closeModal();
            setTimeout(() => {
                generatePDF();
            }, 500);
        }

        // --- PDF GENERATION ---
        window.generatePDF = async function() {
            const pdfButton = document.getElementById('pdf-button');
            if (pdfButton) {
                pdfButton.disabled = true;
                pdfButton.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Menjana PDF...</div>`;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
            
            const personalityScores = calculatePersonalityScores();
            const wellbeingScore = calculateWellbeingScore();
            const resilienceScore = calculateResilienceScore();
            const demographics = state.responses.demographics;
            
            const getTahap = (score) => (score >= 67 ? 'Tinggi' : 'Sederhana');
            const getWellbeingTahap = (total) => (total >= 45 ? "Tinggi" : total >= 25 ? "Sederhana" : "Rendah");
            const getResilienceTahap = (mean) => (mean > 4.3 ? 'Tinggi' : mean >= 3.0 ? 'Normal' : 'Rendah');

            const addHeader = (doc) => {
                doc.setFontSize(14).setFont('helvetica', 'bold').text('LAPORAN PROFIL PERSONALITI DAN KESEJAHTERAAN', doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
            };
            const addFooter = (doc) => {
                const pageCount = doc.internal.getNumberOfPages();
                doc.setFontSize(9).setTextColor(100);
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.text(`Halaman ${i} dari ${pageCount}`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 30, { align: 'center' });
                }
            };

            // PAGE 1: DEMOGRAPHICS
            addHeader(doc);
            doc.setFontSize(11).setFont('helvetica', 'bold').text('BAHAGIAN A: MAKLUMAT DIRI', 40, 80);
            doc.autoTable({
                startY: 90,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 4 },
                body: [
                    ['Nama Penuh', demographics.name || ''],
                    ['Emel', demographics.email || ''],
                    ['Jantina', demographics.gender || ''],
                    ['Bangsa', demographics.race || ''],
                    ['Agama', demographics.religion || ''],
                    ['No. Telefon', `+60${demographics.phone || ''}`],
                    ['IPGM/IPGK', demographics.ipgKampus || ''],
                    ['Jawatan', demographics.jawatan || ''],
                    ['Gred', demographics.gred || ''],
                ],
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 150 }, 1: { cellWidth: 'auto' } },
            });
            
            // PAGE 2: PERSONALITY
            doc.addPage();
            addHeader(doc);
            doc.setFontSize(11).setFont('helvetica', 'bold').text('BAHAGIAN B: PERSONALITI (BIG FIVE)', 40, 80);
            
            const personalityCanvas = document.getElementById('personalityChart');
            const personalityImage = personalityCanvas.toDataURL('image/png', 0.5);
            doc.addImage(personalityImage, 'PNG', 60, 100, 480, 240);
            
            const pBody = Object.keys(personalityScores).map(key => {
                const score = personalityScores[key];
                const interpretations = {
                    extraversion: 'Keseimbangan antara suka bersosial dan bersendirian.',
                    agreeableness: 'Gabungan antara sikap mementingkan diri dan orang lain.',
                    conscientiousness: 'Keseimbangan antara spontan dan teratur.',
                    neuroticism: 'Kestabilan emosi yang sederhana, bertindak balas normal terhadap tekanan.',
                    openness: 'Keseimbangan antara menghargai tradisi dan keterbukaan kepada idea baharu.'
                };
                return [ key.charAt(0).toUpperCase() + key.slice(1), `${score}%`, getTahap(score), interpretations[key] ];
            });

            doc.autoTable({
                startY: 360,
                head: [['Dimensi', 'Skor', 'Tahap', 'Interpretasi']],
                body: pBody,
                headStyles: { fillColor: [22, 160, 133], halign: 'center' },
                columnStyles: { 0: {fontStyle: 'bold'}, 3: { cellWidth: 250 } }
            });

            // PAGE 3: WELLBEING & RESILIENCE
            doc.addPage();
            addHeader(doc);
            doc.setFontSize(11).setFont('helvetica', 'bold').text('BAHAGIAN C: KESEJAHTERAAN DAN DAYA TAHAN', 40, 80);

            const wrBody = [
                [ 'Kesejahteraan Psikologi', wellbeingScore.total, getWellbeingTahap(wellbeingScore.total), 'Merujuk kepada pandangan positif, keyakinan, dan hubungan baik dengan orang lain.' ],
                [ 'Daya Tahan (Resilience)', resilienceScore.mean, getResilienceTahap(resilienceScore.mean), 'Merujuk kepada keupayaan untuk bangkit semula daripada kesukaran dan tekanan.' ]
            ];
            doc.autoTable({
                startY: 100,
                head: [['Konstruk', 'Skor', 'Tahap', 'Interpretasi']],
                body: wrBody,
                headStyles: { fillColor: [22, 160, 133], halign: 'center' },
                columnStyles: { 0: {fontStyle: 'bold'}, 3: { cellWidth: 250 } }
            });

            // PAGE 4: SUMMARY
            doc.addPage();
            addHeader(doc);
            doc.setFontSize(11).setFont('helvetica', 'bold').text('RUMUSAN DAN CADANGAN', 40, 80);
            doc.setFontSize(10).setFont('helvetica', 'normal');
            const summaryText = `Laporan ini adalah untuk rujukan peribadi anda. Ia memberi gambaran umum tentang personaliti dan tahap kesejahteraan anda pada masa ini.\n\nBeberapa cadangan umum:\n- Fokus pada konstruk kesejahteraan dengan skor "Rendah" atau "Sederhana". Rancang tindakan kecil untuk meningkatkan aspek tersebut.\n- Gunakan kekuatan personaliti anda untuk menyokong pembelajaran dan perhubungan anda. Contohnya, jika anda tinggi dalam "Extraversion", libatkan diri dalam aktiviti kumpulan.\n- Jika skor "Neuroticism" anda tinggi, pelajari teknik pengurusan stres seperti meditasi atau senaman pernafasan.\n- Jika anda mengalami tekanan atau memerlukan sokongan, sila berhubung dengan Kaunselor di Unit Psikologi dan Kaunseling IPGM/IPGK anda.\n\nPenafian: Laporan ini dijana secara automatik berdasarkan jawapan yang diberikan. Ia bukan satu diagnosis klinikal. Untuk maklumat lanjut, sila rujuk kaunselor bertauliah.`;
            const splitText = doc.splitTextToSize(summaryText, 515);
            doc.text(splitText, 40, 100);

            addFooter(doc);

            const fileName = `Laporan_Profil_${demographics.name.replace(/ /g, '_') || 'Responden'}.pdf`;
            doc.save(fileName);

            if (pdfButton) {
                pdfButton.disabled = false;
                pdfButton.innerHTML = 'Muat Turun Laporan PDF';
            }
        }

        // --- UI RENDERING ---
        function render() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = '';
            appDiv.className = 'max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 bg-white min-h-screen shadow-lg rounded-lg my-8 fade-in';

            if (state.showResults) {
                appDiv.innerHTML = renderResults();
                setTimeout(() => { createPersonalityChart(); }, 100);
            } else if (state.currentSection === -1) {
                appDiv.innerHTML = renderWelcome();
            } else {
                let content = renderProgressBar();
                if (state.currentSection === 0) content += renderDemographics();
                else if (state.currentSection === 1) content += renderQuestionnaireSection('B', 'Personaliti', personalityQuestions, 'personality', 'blue');
                else if (state.currentSection === 2) content += renderQuestionnaireSection('C', 'Kesejahteraan Psikologi', wellbeingQuestions, 'wellbeing', 'green');
                else if (state.currentSection === 3) content += renderQuestionnaireSection('D', 'Daya Tahan (Resilience)', resilienceQuestions, 'resilience', 'indigo');
                content += renderNavigationButtons();
                appDiv.innerHTML = content;
            }
        }
        function renderWelcome() {
            return `
                <div class="text-center py-10 px-4">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">Selamat Datang</h1>
                    <p class="text-md text-gray-600 max-w-2xl mx-auto mb-4">
                        Profil Kesejahteraan dan Personaliti Warga (PKPW) adalah ujian bagi mengenalpasti tahap kesejahteraan psikologi, tret personaliti dan daya tahan warga kerja di IPGM.
                    </p>
                    <p class="text-md font-semibold text-gray-700 mb-10">
                        Komitmen masa untuk menjawab adalah sekitar 20-25 minit.
                    </p>

                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Tinjauan Soal Selidik</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 max-w-3xl mx-auto">
                        <!-- Card A -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm text-center">
                            <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            </div>
                            <h3 class="font-bold text-gray-800">Bahagian A</h3>
                            <p class="text-sm text-gray-600">Maklumat Diri</p>
                        </div>
                        <!-- Card B -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm text-center">
                            <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-4">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            </div>
                            <h3 class="font-bold text-gray-800">Bahagian B</h3>
                            <p class="text-sm text-gray-600">Personaliti Diri</p>
                        </div>
                        <!-- Card C -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm text-center">
                            <div class="w-16 h-16 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                            </div>
                            <h3 class="font-bold text-gray-800">Bahagian C</h3>
                            <p class="text-sm text-gray-600">Kesejahteraan</p>
                        </div>
                        <!-- Card D -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm text-center">
                            <div class="w-16 h-16 rounded-full bg-yellow-100 flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                            </div>
                            <h3 class="font-bold text-gray-800">Bahagian D</h3>
                            <p class="text-sm text-gray-600">Daya Tahan</p>
                        </div>
                    </div>

                    <button onclick="startSurvey()" class="mt-10 bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                        Mula Soal Selidik
                    </button>
                </div>
            `;
        }
        function renderProgressBar() {
            const progress = (state.currentSection / 4) * 100;
            const sectionNames = ['Demografi', 'Personaliti', 'Kesejahteraan', 'Daya Tahan'];
            return `<div class="mb-8"> <div class="flex justify-between mb-1"> <span class="text-base font-medium text-blue-700">Bahagian ${state.currentSection + 1} dari 4</span> <span class="text-sm font-medium text-blue-700">${sectionNames[state.currentSection]}</span> </div> <div class="w-full bg-gray-200 rounded-full h-2.5"> <div class="bg-blue-600 h-2.5 rounded-full progress-bar-animated" style="width: ${progress}%"></div> </div> </div>`;
        }
        function renderDemographics() {
            let fieldsHtml = demographicsQuestions.map(q => {
                const value = state.responses.demographics[q.id] || '';
                if (q.type === 'select') {
                    return `<div class="mb-4"> <label for="${q.id}" class="block text-sm font-medium text-gray-700 mb-1">${q.label}${q.required ? ' <span class="text-red-500">*</span>' : ''}</label> <select id="${q.id}" name="${q.id}" onchange="handleDemographicChange('${q.id}', this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md"> <option value="" ${value === '' ? 'selected' : ''} disabled>Sila pilih...</option> ${q.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')} </select> </div>`;
                }
                if (q.id === 'phone') {
                    return `<div class="mb-4"> <label for="${q.id}" class="block text-sm font-medium text-gray-700 mb-1">${q.label}${q.required ? ' <span class="text-red-500">*</span>' : ''}</label> <div class="flex mt-1"> <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">+60</span> <input type="${q.type}" id="${q.id}" name="${q.id}" value="${value}" oninput="handleDemographicChange('${q.id}', this.value)" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:ring-blue-500 focus:border-blue-500 sm:text-sm border-gray-300"> </div> </div>`;
                }
                return `<div class="mb-4 relative"> <label for="${q.id}" class="block text-sm font-medium text-gray-700 mb-1">${q.label}${q.required ? ' <span class="text-red-500">*</span>' : ''}</label> <input type="${q.type}" id="${q.id}" name="${q.id}" value="${value}" oninput="handleDemographicChange('${q.id}', this.value)" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" ${q.required ? 'required' : ''} ${q.maxLength ? `maxlength="${q.maxLength}"` : ''} ${q.pattern ? `pattern="${q.pattern}"` : ''}></div>`;
            }).join('');
            return `<h2 class="text-2xl font-bold text-gray-800 mb-1">Bahagian A: Maklumat Demografi</h2> <p class="text-gray-600 mb-6">Sila lengkapkan semua maklumat di bawah.</p> <form onsubmit="event.preventDefault();">${fieldsHtml}</form>`;
        }
        function renderQuestionnaireSection(sectionId, title, questions, sectionKey, color) {
            const likertLabels = [ { val: 1, text: 'Sangat Tidak Setuju' }, { val: 2, text: 'Tidak Setuju' }, { val: 3, text: 'Neutral' }, { val: 4, text: 'Setuju' }, { val: 5, text: 'Sangat Setuju' } ];
            const questionsHtml = questions.map((q, index) => {
                const response = state.responses[sectionKey][index];
                const radioButtons = likertLabels.map(({val}) => {
                    const isChecked = response === val;
                    return `<div class="radio-container"> <input type="radio" id="${sectionKey}-${index}-${val}" name="${sectionKey}-${index}" value="${val}" class="sr-only" onchange="window.handle${sectionKey.charAt(0).toUpperCase() + sectionKey.slice(1)}Change(${index}, this.value)" ${isChecked ? 'checked' : ''}> <label for="${sectionKey}-${index}-${val}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 cursor-pointer ${isChecked ? `bg-${color}-600 text-white shadow-lg transform scale-110` : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}"> ${val} </label> </div>`;
                }).join('');
                return `<div class="p-4 rounded-lg mb-3 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} border border-gray-200"> <p class="text-gray-800 mb-3 text-sm sm:text-base">${index + 1}. ${q}</p> <div class="flex justify-between items-center space-x-2 sm:space-x-4"> ${radioButtons} </div> </div>`;
            }).join('');
            const legendHtml = `<div class="grid grid-cols-5 gap-2 text-center text-xs text-gray-600 font-medium px-4 mb-4">` + likertLabels.map(label => `<div><div class="font-bold">${label.val}</div><div>${label.text}</div></div>`).join('') + `</div>`;
            return `<h2 class="text-2xl font-bold text-gray-800 mb-1">Bahagian ${sectionId}: ${title}</h2> <p class="text-gray-600 mb-4">Sila tandakan jawapan anda pada skala yang disediakan.</p> ${legendHtml} <div>${questionsHtml}</div>`;
        }
        function renderNavigationButtons() {
            const isLastSection = state.currentSection === 3;
            return `<div class="mt-8 flex ${state.currentSection > 0 ? 'justify-between' : 'justify-end'} items-center"> ${state.currentSection > 0 ? `<button onclick="handlePrevSection()" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition-colors">Kembali</button>` : ''} <button onclick="${isLastSection ? 'processAndShowPopup()' : 'handleNextSection()'}" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors"> ${isLastSection ? 'Hantar & Lihat Keputusan' : 'Seterusnya'} </button> </div>`;
        }
        function renderResults() {
            const wellbeingScore = calculateWellbeingScore();
            const resilienceScore = calculateResilienceScore();
            const getWellbeingTahap = (total) => (total >= 45 ? "Tinggi" : total >= 25 ? "Sederhana" : "Rendah");
            const getResilienceTahap = (mean) => (mean > 4.3 ? 'Tinggi' : mean >= 3.0 ? 'Normal' : 'Rendah');

            return `<div class="text-center"> <h1 class="text-3xl font-bold text-gray-800">Laporan Profil Anda</h1> <p class="text-gray-600 mt-2">Terima kasih kerana melengkapkan soal selidik. Berikut adalah ringkasan keputusan anda.</p> </div>
            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h3 class="font-bold text-lg text-green-700">Kesejahteraan Psikologi</h3>
                    <p class="text-5xl font-bold text-green-600 my-2">${wellbeingScore.total}</p>
                    <p class="font-semibold text-green-800 bg-green-100 px-3 py-1 rounded-full inline-block">Tahap: ${getWellbeingTahap(wellbeingScore.total)}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h3 class="font-bold text-lg text-indigo-700">Daya Tahan (Resilience)</h3>
                    <p class="text-5xl font-bold text-indigo-600 my-2">${resilienceScore.mean}</p>
                    <p class="font-semibold text-indigo-800 bg-indigo-100 px-3 py-1 rounded-full inline-block">Tahap: ${getResilienceTahap(resilienceScore.mean)}</p>
                </div>
            </div>
            <div class="mt-6 p-6 bg-gray-50 rounded-lg border">
                <div class="h-80"><canvas id="personalityChart"></canvas></div>
            </div>
            <div class="mt-8 text-center"> <button id="pdf-button" onclick="generatePDF()" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors shadow-lg"> Muat Turun Semula Laporan PDF </button> </div>`;
        }

        // --- CHART CREATION ---
        function createPersonalityChart() {
            const ctx = document.getElementById('personalityChart');
            if (!ctx) return;
            const scores = calculatePersonalityScores();
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Extraversion', 'Agreeableness', 'Conscientiousness', 'Neuroticism', 'Openness'],
                    datasets: [{
                        label: 'Skor Personaliti (%)',
                        data: Object.values(scores),
                        backgroundColor: ['#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: 'Profil Personaliti (Big Five)' } }, scales: { y: { beginAtZero: true, max: 100 } } }
            });
        }
        
        // --- MODAL DIALOG ---
        function showModal(message) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `<div class="modal-overlay fade-in"> <div class="modal-content"> <h3 class="text-lg font-bold text-red-600 mb-4">Perhatian!</h3> <p class="text-gray-700 mb-6">${message}</p> <button onclick="closeModal()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">OK</button> </div> </div>`;
        }
        function showDownloadPopup() {
            const modalContainer = document.getElementById('modal-container');
            const modalHTML = `
                <div class="modal-overlay fade-in">
                    <div class="modal-content">
                        <h3 class="text-lg font-bold text-blue-600 mb-4">Soal Selidik Selesai!</h3>
                        <p class="text-gray-700 mb-6">Terima kasih kerana menjawab. Keputusan anda telah dijana. Klik butang di bawah untuk memaparkan keputusan anda dan memuat turun salinan PDF.</p>
                        <button onclick="displayAndDownload()" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Papar & Muat Turun Keputusan</button>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
        }
        window.closeModal = function() { document.getElementById('modal-container').innerHTML = ''; }

        // --- INITIALIZATION ---
        window.onload = function() { render(); };
    </script>
</body>
</html>
